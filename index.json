[{"content":"click to enlarge\n Intro My network has changed quite a bit recently. In this post, I\u0026rsquo;ll explain different components of my network and how everything fits together.\n Network Infrastructure:  There are two sites and a cloud VPS, interconnected with Wireguard point to point VPNs, each with their own BGP AS. I chose to use BGP as it allows me to have more control over the segregation of my networks, compared to using areas in OSPF (or other IGP).\n AS65534 - My Home LAN   Ubiquiti Edgerouter X - erx.usman.lan\n WireGuard VPNs to erx.zahid.lan and dn42-vps.lan. eBGP peering sessions, over the VPN connections, to AS65535 and 4242421869. Source NAT on VPN interfaces, such that any outbound traffic destined for DN42, is NATed to a DN42 IP. Router-On-A-Stick VLANs - with a VLAN trunk down to the Cisco 2960G.    Cisco 2960G - usman-cisco.lan\n Basic Layer 2 switching to normal end user hosts.    Raspberry Pi 4 8GB - pi.usman.lan\n Running as a host for Docker apps.    WD 8TB NAS - nas.usman.lan\n SMB Shares.     AS65535 - My Cousin\u0026rsquo;s LAN   Ubiquiti Edgerouter X - erx.zahid.lan\n WireGuard VPNs to erx.usman.lan and dn42.erx.lan eBGP peering sessions, over the VPN connections, to AS65535 and AS4242421869. Source NAT on VPN interfaces, such that any outbound traffic destined for DN42, is NATed to a DN42 IP. Redistributing learned OSPF routes (SVIs from the 3560G) into BGP.    Cisco 3560G - core.zahid.lan\n SVIs for VLANs. Advertising SVIs into the OSPF area 0 domain.    Raspberry Pi 4 8GB - pi.zahid.lan\n Running as a host for Docker apps. 6TB HDD.     AS4242421869 - My DN42 Node   A Cloud VPS running VyOS as my DN42 Node. (See my other posts for more info about DN42). eBGP peering with three upstream DN42 providers, over point to point WireGuard VPNs. eBGP peering with erx.usman.lan (my home network) and erx.zahid.lan. Filtering BGP advertisements using GoRTR RPKI ROA. Filtering BGP exports using route-maps and prefix lists, such that BGP updates from AS65535 and AS65534 aren\u0026rsquo;t advertised to DN42.  Services being hosted:   On the Raspberry Pi Docker Hosts:  Plex Media Server Radarr, Sonarr, Jackett, qBittorrent. Nextcloud. Syncthing. NGINX Proxy Manager - routes a few of the mentioned services through Cloudfare\u0026rsquo;s WAF, for DDOS mitigation and public IP obfuscation.     ","permalink":"https://blog.usman.network/posts/usmannet/","summary":"click to enlarge\n Intro My network has changed quite a bit recently. In this post, I\u0026rsquo;ll explain different components of my network and how everything fits together.\n Network Infrastructure:  There are two sites and a cloud VPS, interconnected with Wireguard point to point VPNs, each with their own BGP AS. I chose to use BGP as it allows me to have more control over the segregation of my networks, compared to using areas in OSPF (or other IGP).","title":"UsmanNet 2022"},{"content":"What is Tunnel Broker? Tunnel Broker (provided by Hurricane Electric) is a service that allows users to connect the IPv6 internet, over IPv4.\nHow it works It essentially works by establishing a GRE tunnel to one of Hurricane Electric\u0026rsquo;s PoPs, via the IPv4 internet, and then running IPv6 ranges over it.\nWhy Tunnel Broker? Accessibility  I decided to setup Tunnel Broker, as my ISP doesn\u0026rsquo;t support IPv6. This would allow access to IPv6-only services on the internet.  Hosting  Due to the abundance of IPv6 addresses, Tunnel Broker can provide multiple /48 ranges. Publicly hosting services would be easier as NAT wouldn\u0026rsquo;t be needed (my end devices would have publicly routable IPv6 addresses). I wouldn\u0026rsquo;t have to mess around with port forwarding/destination NAT. I would only have to modify WAN firewall rules, to allow inbound WAN traffic to my devices.   Configuration Hurricane Electric\u0026rsquo;s Side HE\u0026rsquo;s side of the configuration was straight forward. I made an account and created a regular tunnel.\nThis involved providing my public IPv4 address, selecting a HE PoP location, and claiming the /48 and 64 IPv6 ranges. For the purposes of this article, I\u0026rsquo;ve replaced my real IPv4 and IPv6 ranges.\nIP Addressing For reference:\n HE\u0026rsquo;s public IPv4 address - 1.1.1.1 HE\u0026rsquo;s public IPv6 address - aaa:aaa:aaa:aaa::1/64 - HE\u0026rsquo;s address for their GRE tunnel interface. My client IPv4 address - 6.6.6.6 My client IPv6 address - aaa:aaa:aaa:aaa::2/64 - my address for the local GRE tunnel interface.  Routed Ranges - IPv6 ranges that my end devices can use:\n My Routed /64 - ccc:ccc:ccc:ccc::/64 My Routed /48 - ddd:ddd:ddd::/48   EdgeRouter X Configuration Establishing the GRE Tunnel set interfaces tunnel tun0 address 'aaa:aaa:aaa:aaa::2/64' set interfaces tunnel tun0 description 'HE.NET IPv6 Tunnel' set interfaces tunnel tun0 encapsulation sit set interfaces tunnel tun0 local-ip 6.6.6.6 set interfaces tunnel tun0 multicast disable set interfaces tunnel tun0 remote-ip 1.1.1.1 set interfaces tunnel tun0 ttl 255 set protocols static interface-route6 '::/0' next-hop-interface tun0 This:\n Creates a GRE tunnel called tun0. Sets the GRE encapsulation to SIT. Sets the local and remote tunnel endpoint IPs. Sets an IPv6 default interface route to tun0, so that all IPv6 internet traffic goes down the interface.  Testing the GRE Tunnel To verify the GRE tunnel connectivity, I pinged the HE server endpoint (aaa:aaa:aaa:aaa::1).\nusman@usman-erx:~$ ping6 aaa:aaa:aaa:aaa::1 PING aaa:aaa:aaa:aaa::1(aaa:aaa:aaa:aaa::1) 56 data bytes 64 bytes from aaa:aaa:aaa:aaa::1: icmp_seq=1 ttl=120 time=13.7 ms 64 bytes from aaa:aaa:aaa:aaa::1: icmp_seq=2 ttl=120 time=13.7 ms 64 bytes from aaa:aaa:aaa:aaa::1: icmp_seq=3 ttl=120 time=20.7 ms 64 bytes from aaa:aaa:aaa:aaa::1: icmp_seq=4 ttl=120 time=12.0 ms --- aaa:aaa:aaa:aaa::1 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 3009ms rtt min/avg/max/mdev = 12.038/15.082/20.748/3.347 ms usman@usman-erx:~$ From my Edgerouter, I was able to ping the HE IPv6 server endpoint, over the GRE tunnel.\nAn average of 11ms latency - which is more than acceptable.\n I was also able to ping Google\u0026rsquo;s IPv6 DNS server.\nAs per the IPv6 routing table, any unspecified traffic was routed over the tun0 interface.\nusman@usman-erx:~$ ping6 2001:4860:4860::8888 PING 2001:4860:4860::8888(2001:4860:4860::8888) 56 data bytes 64 bytes from 2001:4860:4860::8888: icmp_seq=1 ttl=120 time=19.4 ms 64 bytes from 2001:4860:4860::8888: icmp_seq=2 ttl=120 time=19.8 ms 64 bytes from 2001:4860:4860::8888: icmp_seq=3 ttl=120 time=13.8 ms 64 bytes from 2001:4860:4860::8888: icmp_seq=4 ttl=120 time=14.0 ms ^C --- 2001:4860:4860::8888 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 3009ms rtt min/avg/max/mdev = 13.854/16.802/19.838/2.836 ms usman@usman-erx:~$ show ipv6 route IPv6 Routing Table Codes: K - kernel route, C - connected, S - static, R - RIP, O - OSPF, IA - OSPF inter area, E1 - OSPF external type 1, E2 - OSPF external type 2, N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2, B - BGP Timers: Uptime IP Route Table for VRF \u0026quot;default\u0026quot; S ::/0 [1/0] via ::, tun0, 01w3d04h C ::1/128 via ::, lo, 02w1d22h C aaa:aaa:aaa:aaa::/64 via ::, tun0, 01w3d04h C fe80::/64 via ::, tun0, 01w3d04h  IPv6 Router Advertisements Once my EdgeRouter was IPv6 enabled, I set about connecting my end devices. I used router adverts to automatically assign the addresses my devices.\nIt uses a /64 IPv6 prefix (from my routable /48) and the client\u0026rsquo;s MAC address, to create an IPv6 address. This is a form of Stateless Address Auto Configuration (SLAAC).\nI use router on a stick VLANs, where virtual interfaces are defined on my EdgeRouter. This made is easy to configure the RA.\nE.g. For VLAN 20, I created a /64 subnet out of my original /48 - ddd:ddd:ddd:20::/64.\nset interfaces switch switch0 vif 20 ipv6 address eui64 'ddd:ddd:ddd:20::/64' set interfaces switch switch0 vif 20 ipv6 router-advert name-server '2001:4860:4860::8888' set interfaces switch switch0 vif 20 ipv6 router-advert prefix 'ddd:ddd:ddd:20::/64' This:\n Sets vif 20 an ipv6 address, comprised of ddd:ddd:ddd:20::/64 and vif 20\u0026rsquo;s MAC address. Sets Google\u0026rsquo;s IPv6 DNS as the name server. Advertises the prefix to the clients.  vif 20 was set a IPv6 address of ddd:ddd:ddd:20:7683:c2ff:fef5:dadb/64 - which would be the default gateway for end devices on VLAN 20.\nusman@usman-erx:~$ show interfaces Codes: S - State, L - Link, u - Up, D - Down, A - Admin Down Interface IP Address S/L Description --------- ---------- --- ----------- switch0.20 10.0.20.1/24 u/u IoT ddd:ddd:ddd:20:7683:c2ff:fef5:dadb/64 [..] Verifying Connectivity On End Devices Using SLAAC, my Debian based Raspberry Pi had been delegated the IPv6 address:\ninet6 ddd:ddd:ddd:20:e7d5:6b06:84cd:9ae7 from the ddd:ddd:ddd:20::/64 prefix.\nusman@raspberrypi:~$ sudo ifconfig eth0 eth0: flags=4163\u0026lt;UP,BROADCAST,RUNNING,MULTICAST\u0026gt; mtu 1500 inet 10.0.10.14 netmask 255.255.255.0 broadcast 10.0.10.255 inet6 fe80::e6ea:3e88:42f3:53e5 prefixlen 64 scopeid 0x20\u0026lt;link\u0026gt; inet6 ddd:ddd:ddd:20:e7d5:6b06:84cd:9ae7 prefixlen 64 scopeid 0x0\u0026lt;global\u0026gt; ether e4:5f:01:25:18:aa txqueuelen 1000 (Ethernet) RX packets 667315319 bytes 748041609 (713.3 MiB) RX errors 108935 dropped 108935 overruns 0 frame 0 TX packets 648634493 bytes 464678115 (443.1 MiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 usman@raspberrypi:~$ To verify connectivity, I also ran a traceroute to Google\u0026rsquo;s IPv6 DNS server.\nusman@raspberrypi:~$ traceroute6 2001:4860:4860::8888 traceroute to 2001:4860:4860::8888 (2001:4860:4860::8888), 30 hops max, 80 byte packets 1 ddd:ddd:ddd:20:7683:c2ff:fef5:dadb (ddd:ddd:ddd:20:7683:c2ff:fef5:dadb) 0.512 ms 0.421 ms 0.580 ms 2 tunnel718369.tunnel.tserv5.lon1.ipv6.he.net (2001:470:1f08:213::1) 19.324 ms 26.367 ms 17.280 ms 3 e0-19.core2.lon2.he.net (2001:470:0:67::1) 17.346 ms 20.102 ms 22.073 ms 4 2001:7f8:be::1:5169:1 (2001:7f8:be::1:5169:1) 43.789 ms 43.786 ms 43.788 ms 5 2a00:1450:80f9::1 (2a00:1450:80f9::1) 26.844 ms 2a00:1450:8125::1 (2a00:1450:8125::1) 19.985 ms * 6 dns.google (2001:4860:4860::8888) 25.651 ms 13.551 ms 17.539 ms The traceroute confirmed that the traffic goes through my EdgeRouter\u0026rsquo;s IPv6 interface ddd:ddd:ddd:20:7683:c2ff:fef5:dadb, over the GRE tunnel and HE\u0026rsquo;s infrastructure, and out to Google.\n Firewalling As my devices had publicly routable IPv6 addresses delegated to them, I added firewall rules to inbound limit traffic.\nI created two firewall lists WAN_IN (from the internet to end devices) and WAN_Local (from the internet to the router).\nset firewall ipv6-name WAN_In default-action drop set firewall ipv6-name WAN_In rule 10 action accept set firewall ipv6-name WAN_In rule 10 description 'allow established/related traffic' set firewall ipv6-name WAN_In rule 10 protocol all set firewall ipv6-name WAN_In rule 10 state established enable set firewall ipv6-name WAN_In rule 10 state related enable set firewall ipv6-name WAN_In rule 20 action drop set firewall ipv6-name WAN_In rule 20 protocol all set firewall ipv6-name WAN_In rule 20 state invalid enable set firewall ipv6-name WAN_In rule 30 action accept set firewall ipv6-name WAN_In rule 30 description 'allow icmpv6' set firewall ipv6-name WAN_In rule 30 protocol icmpv6 set firewall ipv6-name WAN_Local default-action drop set firewall ipv6-name WAN_Local rule 10 action accept set firewall ipv6-name WAN_Local rule 10 description 'allow established/related traffic' set firewall ipv6-name WAN_Local rule 10 protocol all set firewall ipv6-name WAN_Local rule 10 state established enable set firewall ipv6-name WAN_Local rule 10 state related enable set firewall ipv6-name WAN_Local rule 20 action drop set firewall ipv6-name WAN_Local rule 20 protocol all set firewall ipv6-name WAN_Local rule 20 state invalid enable set firewall ipv6-name WAN_Local rule 30 action accept set firewall ipv6-name WAN_Local rule 30 description 'allow icmpv6' set firewall ipv6-name WAN_Local rule 30 protocol icmpv6 Both firewall lists have 3 rules:\n Default action for inbound traffic is drop. Rule 10 - allows established and related traffic, from WAN to end devices. Rule 20 - drops invalid state packets. Rule 30 - Allows ICMPv6.  I then associated the rule lists with the GRE tun0 interface, which filtered the traffic.\nset interfaces tunnel tun0 firewall in ipv6-name WAN_In set interfaces tunnel tun0 firewall local ipv6-name WAN_Local ","permalink":"https://blog.usman.network/posts/hurricane-electric-ipv6/","summary":"What is Tunnel Broker? Tunnel Broker (provided by Hurricane Electric) is a service that allows users to connect the IPv6 internet, over IPv4.\nHow it works It essentially works by establishing a GRE tunnel to one of Hurricane Electric\u0026rsquo;s PoPs, via the IPv4 internet, and then running IPv6 ranges over it.\nWhy Tunnel Broker? Accessibility  I decided to setup Tunnel Broker, as my ISP doesn\u0026rsquo;t support IPv6. This would allow access to IPv6-only services on the internet.","title":"Hurricane Electric IPv6 Tunnel Broker On a Ubiquiti EdgeRouter"},{"content":"I recently connected to the DN42 BGP mesh, a big network which employs WAN technologies to create an internet like mesh. Read my first most for more info on DN42.\nIn this post, I\u0026rsquo;ll go over how I:\n Provisioned an AWS Linux VPS. Created a WireGuard Site2Site VPN Connection between my Ubiquiti EdgeRouter and VPS. Utilized the BIRD internet routing daemon to handle internal BGP routing over that VPN connection.  The end goal was to have the AWS VPS be able to access the DN42 mesh (using iBGP) via my EdgeRouter, and then through the EdgeRouter\u0026rsquo;s 5 eBGP peerings (see diagram).\nProvisioning the AWS VPS After creating an AWS free tier account, I chose to use a new Debian Instance. Any modern Linux distribution (with BIRD, WireGuard and a Public IP address) should suffice.\nI selected the free tier eligible t2.micro. It comes with a 2.5Ghz vCPU, 1GB of RAM and 7GB of storage, which is plenty for a BGP router with a route table the size of DN42\u0026rsquo;s (~600 prefixes). One I launched the VPS, I connected to it using my generated AWS SSH private key.\nssh -i C:\\Users\\Usman\\.ssh\\AWS_Access.pem admin@AWS-VPS root@AWS-VPS:/home/admin# neofetch _,met$$$$$gg. root@AWS-VPS ,g$$$$$$$$$$$$$$$P. -------------------- ,g$$P\u0026quot; \u0026quot;\u0026quot;\u0026quot;Y$$.\u0026quot;. OS: Debian GNU/Linux 10 (buster) x86_64 ,$$P' `$$$. Host: HVM domU 4.2.amazon ',$$P ,ggs. `$$b: Kernel: 4.19.0-18-cloud-amd64 `d$$' ,$P\u0026quot;' . $$$ Uptime: 16 hours $$P d$' , $$P Packages: 452 (dpkg) $$: $$. - ,d$$' Shell: bash 5.0.3 $$; Y$b._ _,d$P' CPU: Intel Xeon E5-2686 v4 (1) @ 2.300GHz Y$$. `.`\u0026quot;Y$$$$P\u0026quot;' GPU: Cirrus Logic GD 5446 `$$b \u0026quot;-.__ Memory: 74MiB / 987MiB `Y$$ `Y$$. `$$b. `Y$$b. `\u0026quot;Y$b._ `\u0026quot;\u0026quot;\u0026quot; Installing the required packages Next, I upgraded the system packages, installed WireGuard and the BIRD routing daemon.\nroot@AWS-VPS:~$ sudo apt update \u0026amp;\u0026amp; sudo apt upgrade -y root@AWS-VPS:~$ sudo apt install wireguard root@AWS-VPS:~$ sudo apt install bird  Establishing the WireGuard VPN Tunnel Generating Key Pairs After the installation, I generated WireGuard Public and Private Key Pairs, on my EdgeRouter and VPS. Where each peer has public/private key pair, and only needs to know the peer\u0026rsquo;s public key.\nOn the EdgeRouter:\nusman@ER-X:~$ mkdir /home/usman/wgconfs/AWS usman@ER-X:~$ cd /home/usman/wgconfs/AWS usman@ER-X:~/wgconfs/AWS$ wg genkey | tee privatekey | wg pubkey \u0026gt; publickey usman@ER-X:~/wgconfs/AWS$ ls private public On the VPS:\nroot@AWS-VPS:~$ cd /etc/wireguard/ root@AWS-VPS:/etc/wireguard$ wg genkey | tee privatekey | wg pubkey \u0026gt; publickey usman@AWS-VPS:~/etc/wireguard$ ls private public  WireGuard on the EdgeRouter set interfaces wireguard wg67 address 10.132.0.2/30 set interfaces wireguard wg67 mtu 1420 set interfaces wireguard wg67 peer LHv3equY4NyDeLVCY1+P5IrCA23+bYLixB18ehHjzzM= allowed-ips 0.0.0.0/0 set interfaces wireguard wg67 peer LHv3equY4NyDeLVCY1+P5IrCA23+bYLixB18ehHjzzM= endpoint 'aws.vps.com:51823' set interfaces wireguard wg67 private-key /home/usman/wgconfs/privatekey set interfaces wireguard wg67 route-allowed-ips false What this does:\n Creates a WireGuard Interface, called wg67 with an IP address of 10.132.0.2 Sets the MTU to 1420 Creates a peer with the public key of LHv3equY4NyDeLVCY1+P5IrCA23+bYLixB18ehHjzzM= Allows any ip address to flow over the tunnel. Specifies the public IP endpoint of the AWS VPS. Associates the previously generated private key with the wg67 interface. Set the route-allowed-ips value to false, as that would create a default route via the VPS.  Allowing WireGuard through the EdgeRouter\u0026rsquo;s firewall set firewall name WAN_LOCAL rule 25 action accept set firewall name WAN_LOCAL rule 25 description iBGP-AWS set firewall name WAN_LOCAL rule 25 destination port 51823 set firewall name WAN_LOCAL rule 25 log enable set firewall name WAN_LOCAL rule 25 protocol udp What this does:\n Creates an accept rule in the WAN_LOCAL rule set, which regulates traffic from the WAN interface, to the router. Accepts all incoming UDP connections on port 51823, from the AWS VPS.   WireGuard on the AWS Debian VPS WireGuard on Linux is similar to the EdgeRouter\u0026rsquo;s config.\nip link add dev wg0 type wireguard ip address add dev wg0 10.132.0.1/30 wg set wg0 listen-port 51823 private-key /etc/wireguard/privatekey peer \u0026lt;erxpubkey\u0026gt; allowed-ips 0.0.0.0/0 endpoint \u0026lt;erx.pub.ip\u0026gt;:51823 ip link set up dev wg0 ip addr add 172.22.132.169/32 dev lo What this does:\n Creates an interface called wg0, with the type wireguard. Assigns the address 10.132.0.1/30 to the wg0 interface. Sets the server listen port to 51823. Sets the privatekey to the location of the previously generated private key. Allows any ip address over the tunnel. Specifies the public IP and port of the EdgeRouter peer.  Allowing WireGuard through AWSs Security Group I also modified the VPS\u0026rsquo;s security group, so that it allows incoming udp connections on port 51823, from the EdgeRouter.\n Testing Reachability After configuring the Firewall Rules, I was able to ping between the VPS and EdgeRouter, over the WireGuard VPN Interface.\nFrom the EdgeRouter, to the VPS:\nusman@ER-X:~$ ping 10.132.0.1 PING 10.132.0.1 (10.132.0.1) 56(84) bytes of data. 64 bytes from 10.132.0.1: icmp_seq=1 ttl=64 time=31.4 ms 64 bytes from 10.132.0.1: icmp_seq=2 ttl=64 time=31.5 ms 64 bytes from 10.132.0.1: icmp_seq=3 ttl=64 time=35.0 ms 64 bytes from 10.132.0.1: icmp_seq=4 ttl=64 time=34.3 ms 64 bytes from 10.132.0.1: icmp_seq=5 ttl=64 time=31.8 ms From the VPS to the EdgeRouter:\nadmin@AWS-VPS:~$ ping 10.132.0.2 PING 10.132.0.2 (10.132.0.2) 56(84) bytes of data. 64 bytes from 10.132.0.2: icmp_seq=1 ttl=64 time=39.4 ms 64 bytes from 10.132.0.2: icmp_seq=2 ttl=64 time=34.7 ms 64 bytes from 10.132.0.2: icmp_seq=3 ttl=64 time=34.8 ms 64 bytes from 10.132.0.2: icmp_seq=4 ttl=64 time=29.5 ms 64 bytes from 10.132.0.2: icmp_seq=5 ttl=64 time=28.9 ms The latency ranges from 30-40 ms, which perfectly acceptable for a VPN connection over the internet.\nWireGuard also provides some diagnostic data (e.g. data usage, latest handshake etc.).\nOn the EdgeRouter:\nusman@ER-X:~$ sudo wg interface: wg67 public key: P1FrJ1IpHCFX3Tk/4aFxbrCbD4VDefwHaieVWDWoXx0= private key: (hidden) listening port: 51650 peer: LHv3equY4NyDeLVCY1+P5IrCA23+bYLixB18ehHjzzM= endpoint: AWS-pub.ip:51823 allowed ips: 0.0.0.0/0 latest handshake: 46 seconds ago transfer: 252.68 MiB received, 30.28 MiB sent On the VPS:\nroot@AWS-VPS:~# wg interface: wg67 public key: LHv3equY4NyDeLVCY1+P5IrCA23+bYLixB18ehHjzzM= private key: (hidden) listening port: 51823 peer: P1FrJ1IpHCFX3Tk/4aFxbrCbD4VDefwHaieVWDWoXx0= endpoint: edgerouter-pub.ip:51650 allowed ips: 0.0.0.0/0 latest handshake: 46 seconds ago transfer: 30.21 MiB received, 252.70 MiB sent  iBGP Configuration Once the VPN was up, I set about creating a internal BGP peering between the EdgeRouter and VPS (so that the VPS could reach DN42, via the EdgeRouter\u0026rsquo;s upstream transit peers).\nWhy BIRD Internet Routing Daemon? I chose to use the free and open-source BIRD routing daemon as its widely used in the DN42 mesh and on the real internet.\nNetflix proudly uses BIRD to run their global CDN backbone, which handles ~100Tbps at peak. So its probably fine for DN42\u0026rsquo;s few hundred routes.\nBIRD BGP Configuration on the VPS Upon installation, BIRD created a template configuration file in /etc/bird/bird.conf. I just had to add some parameters regarding my own BGP peering and WireGuard tunnel.\nroot@AWS-VPS:/etc/bird# vim bird.conf router id 172.22.132.169; protocol kernel { scan time 20; import none; export filter { if source = RTS_STATIC then reject; krt_prefsrc = 172.22.132.169; accept; }; }; protocol device { scan time 60; } protocol direct { interface \u0026quot;*\u0026quot;; } protocol bgp { description \u0026quot;BIRD BGP CONFIG\u0026quot;; local as 4242421869; neighbor 10.132.0.2 as 4242421869; graceful restart; import all; export all; } What this does:\n Sets the router ID to 172.22.132.169 - an IP address in my designated DN42 range (claimed by my ASN). Creates a kernel table. The Kernel protocol is not a real routing protocol. Instead of communicating with other routers in the network, it performs synchronization of BIRD\u0026rsquo;s routing tables with the OS kernel. Creates protocol direct and protocol device, which are BIRD specific settings. Initialises the BGP protocol on BIRD, with the local ASN of 4242421869. Sets the neighbour remote ASN to 4242421869 via 10.132.0.2 (the WireGuard IP address for the EdgeRouter). The use of the same local and remote ASN triggers internal BGP, as opposed to external BGP.  BGP Configuration for the EdgeRouter BGP on the EdgeRouter similar to BIRD.\nset protocols bgp 4242421869 parameters router-id 172.22.132.161 set protocols bgp 4242421869 neighbor 10.132.0.1 description iBGP set protocols bgp 4242421869 neighbor 10.132.0.1 nexthop-self set protocols bgp 4242421869 neighbor 10.132.0.1 remote-as 4242421869 set protocols bgp 4242421869 neighbor 10.132.0.1 soft-reconfiguration inbound What this does:\n Creates an instance of BGP, with my local ASN (4242421869) and router id 172.22.132.161. Sets the neighbour remote ASN to 4242421869 via 10.132.0.1 (the WireGuard IP address for the AWS VPS). Enables next-hop self, which forces the router to do a recursive lookup in order to determine which egress interface should be used to send the packets out. Enables soft-reconfiguration inbound.   Verifying the iBGP Peering On the EdgeRouter, the BGP state had changed to \u0026ldquo;Established\u0026rdquo;, its announcing 463 routes to the VPS, at IP 10.132.0.1 (the WireGuard peer IP).\nusman@ER-X:~$ show ip bgp neighbors 10.132.0.1 BGP neighbor is 10.132.0.1, remote AS 4242421869, local AS 4242421869, internal link BGP version 4, remote router ID 172.22.132.169 BGP state = Established, up for 17:26:23 Last read 17:26:23, hold time is 180, keepalive interval is 60 seconds Neighbor capabilities: Route refresh: advertised and received (new) 4-Octet ASN Capability: advertised and received Address family IPv4 Unicast: advertised and received Received 5794 messages, 21 notifications, 0 in queue Sent 20084 messages, 12 notifications, 0 in queue Route refresh request: received 0, sent 0 Minimum time between advertisement runs is 5 seconds For address family: IPv4 Unicast BGP table version 43303, neighbor version 43303 Index 0, Offset 0, Mask 0x1 Graceful restart: received Inbound soft reconfiguration allowed NEXT_HOP is always this router Community attribute sent to this neighbor (both) 0 accepted prefixes 463 announced prefixes Connections established 23; dropped 22 Local host: 10.132.0.2, Local port: 179 Foreign host: 10.132.0.1, Foreign port: 54586 Nexthop: 10.132.0.2 Nexthop global: :: Nexthop local: :: BGP connection: non shared network Last Reset: 17:26:23, due to BGP Notification sent Notification Error Message: (Cease/Administratively Reset.) On the AWS VPS:\nAfter entering the birdc shell on the VPS, I could also see that the BGP state had been established.\nIts accepting those 463 routes that the EdgeRouter advertised, over the WireGuard tunnel (IP address 10.132.0.2).\nroot@AWS-VPS:~# birdc bird\u0026gt; show protocols bgp1 bgp1 BGP master up 16:37:06 Established Description: BIRD BGP CONFIG Preference: 100 Input filter: ACCEPT Output filter: REJECT Routes: 463 imported, 0 exported, 463 preferred Route change stats: received rejected filtered ignored accepted Import updates: 466 0 0 0 466 Import withdraws: 0 0 --- 0 0 Export updates: 469 466 3 --- 0 Export withdraws: 0 --- --- --- 0 BGP state: Established Neighbor address: 10.132.0.2 Neighbor AS: 4242421869 Neighbor ID: 172.22.132.161 Neighbor caps: refresh AS4 Session: internal multihop AS4 Source address: 10.132.0.1 Hold timer: 147/180 Keepalive timer: 40/60 bird\u0026gt;  Inspecting VPS\u0026rsquo;s Route Table The AWS VPS now has DN42\u0026rsquo;s prefixes in its kernel route table.\nDN42 prefixes (172.20.0.0/14) have a gateway of the EdgeRouter, (over the WireGuard VPN tunnel).\nroute -n showing a subset of the VPS\u0026rsquo;s route table:\nroot@AWS-VPS:~# route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 172.31.0.1 0.0.0.0 UG 0 0 0 eth0 172.20.0.53 10.132.0.2 255.255.255.255 UGH 0 0 0 wg0 172.20.1.0 10.132.0.2 255.255.255.0 UG 0 0 0 wg0 172.20.4.32 10.132.0.2 255.255.255.240 UG 0 0 0 wg0 172.20.4.96 10.132.0.2 255.255.255.248 UG 0 0 0 wg0 172.20.4.104 10.132.0.2 255.255.255.248 UG 0 0 0 wg0 172.20.6.224 10.132.0.2 255.255.255.248 UG 0 0 0 wg0 172.20.6.248 10.132.0.2 255.255.255.248 UG 0 0 0 wg0 172.20.8.0 10.132.0.2 255.255.254.0 UG 0 0 0 wg0 172.20.12.192 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 172.20.14.32 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 172.20.14.64 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 172.20.14.192 10.132.0.2 255.255.255.192 UG 0 0 0 wg0 172.20.15.96 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 172.20.16.0 10.132.0.2 255.255.255.128 UG 0 0 0 wg0 172.20.16.128 10.132.0.2 255.255.255.128 UG 0 0 0 wg0 172.20.18.64 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 172.20.18.224 10.132.0.2 255.255.255.240 UG 0 0 0 wg0 172.20.19.64 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 172.20.20.96 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 172.20.28.224 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 Ping Testing Success! Pinging a device inside the DN42 range 172.23.0.80 confirms that I have access to the DN42 network.\nroot@ip-172-31-0-189:~# ping 172.23.0.80 PING 172.23.0.80 (172.23.0.80) 56(84) bytes of data. 64 bytes from 172.23.0.80: icmp_seq=1 ttl=60 time=69.3 ms 64 bytes from 172.23.0.80: icmp_seq=2 ttl=60 time=72.7 ms 64 bytes from 172.23.0.80: icmp_seq=3 ttl=60 time=71.7 ms 64 bytes from 172.23.0.80: icmp_seq=4 ttl=60 time=83.8 ms 64 bytes from 172.23.0.80: icmp_seq=5 ttl=60 time=74.5 ms Traceroute Testing A traceroute to 172.23.0.80 confirms that the packets are flowing:\n First through the Ubiquiti EdgeRouter 10.132.0.2 over the WG VPN tunnel Next through the EdgeRouter\u0026rsquo;s eBGP peering with \u0026lsquo;highdef\u0026rsquo; 172.20.229.116 Through the DN42 network And finally reaches its destination in 5 total hops.  root@AWS-VPS:~# traceroute 172.23.0.80 traceroute to 172.23.0.80 (172.23.0.80), 30 hops max, 60 byte packets 1 10.132.0.2 33.135 ms 33.105 ms 33.088 ms 2 172.20.229.116 52.967 ms 52.948 ms 52.932 ms 3 172.20.129.187 60.474 ms 60.459 ms 60.438 ms 4 172.20.129.169 73.126 ms 73.102 ms 78.113 ms 5 172.23.0.80 78.097 ms 78.078 ms 78.061 ms What Next? In the future, I\u0026rsquo;ll probably launch another VPS, create more BGP peering, but install everything automatically with Ansible.\n","permalink":"https://blog.usman.network/posts/ibgp-aws/","summary":"I recently connected to the DN42 BGP mesh, a big network which employs WAN technologies to create an internet like mesh. Read my first most for more info on DN42.\nIn this post, I\u0026rsquo;ll go over how I:\n Provisioned an AWS Linux VPS. Created a WireGuard Site2Site VPN Connection between my Ubiquiti EdgeRouter and VPS. Utilized the BIRD internet routing daemon to handle internal BGP routing over that VPN connection.","title":"DN42 Part 2: Conecting an AWS VPS to DN42, using iBGP and WireGuard."},{"content":" What is DN42? DN42 is a big network, which employs WAN technologies (BGP, whois database, DNS, etc) to create an internet like mesh.\nMembers connect to each other using VPN tunnels (GRE, OpenVPN, WireGuard, IPsec) and exchange routes via BGP.\nDN42 currently has 410 nodes/users, advertising ~600 prefixes. realtime map\n Why DN42? DN42 allows you to experiment with mentioned internet technologies, without the logistical difficulties and high expenses of registering with real AS registries, on the live internet.\nMore importantly, if you misconfigure something, you don\u0026rsquo;t have to worry about causing global outages - like a Facebook Engineer did.\n How I connected to the mesh. The Registry The registry is based on a Git repository. This allows users to create branches \u0026amp; pull requests, to register, create objects and make changes to their details.\nClaiming an IP Range and AS Number. DN42 uses the 172.20.0.0/14 range for IPv4 addresses.\nAvailable IP ranges and ASNs are can be shown in the DN42 Free Explorer. It randomly shows subnets, that are free and useable, from the range.\nDN42\u0026rsquo;s recommendation is to go with a /27 subnet, which has 30 usable IP addresses, and should be sufficient for most home users.\nFollowing the same process for an ASN and IPv6, I decided to go with:\n An v4 subnet of 172.22.132.160/27 A v6 range of fd5f:2bd0:1feb::/48 An Autonomous System Number of AS4242421869  Making changes to the git repo. After cloning git the repo to my local machine, I created the following files in the data/ directory:\ndata/aut-num/AS4242421869 - the AS Number.\naut-num: AS4242421869\ras-name: AS-USMAN-DN42\radmin-c: USMAN-DN42\rtech-c: USMAN-DN42\rmnt-by: USMAN-MNT\rsource: DN42\rdata/inet6num/fd5f:2bd0:1feb::_48 - IPv6 Range.\ninet6num: fd5f:2bd0:1feb:0000:0000:0000:0000:0000 - fd5f:2bd0:1feb:ffff:ffff:ffff:ffff:ffff\rcidr: fd5f:2bd0:1feb::/48\rnetname: USMAN-NETWORK\rdescr: Network of Usman\radmin-c: USMAN-DN42\rtech-c: USMAN-DN42\rmnt-by: USMAN-MNT\rstatus: ASSIGNED\rsource: DN42\rdata/inetnum/172.22.132.160_27 - IPv4 Range.\ninetnum: 172.22.132.160 - 172.22.132.191\rcidr: 172.22.132.160/27\rnetname: USMAN-NETWORK\radmin-c: USMAN-DN42\rtech-c: USMAN-DN42\rmnt-by: USMAN-MNT\rstatus: ASSIGNED\rsource: DN42\rdata/mntner/USMAN-MNT - data about the maintainer, including my SSH public key (for verification purposes).\nmntner: USMAN-MNT\radmin-c: USMAN-DN42\rtech-c: USMAN-DN42\rmnt-by: USMAN-MNT\rauth: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDOVIdUelAhke7DImFiLdLmK5fIqDrj+UC0fMNwaWzzE/Do9s+8OrlLbyA7UNbnLpXEh6xCaE6ckL1j3Nywv8pSgwgZpnZY1smgCDvMqqRpsfqVTYzCy/6f9tzL80km53JLDKeaJSSikzPhcADpp7eCy6QlWPu+cV3om5cDIEuUvpthGfgFNlrtN88o7ryyInnxaHcr+NYWMcyoocVVieCKKbuBhOe+sCj5IFHuHq5IDX7wNbKRauHE47arhrT6aKWBHFkzMNO/XFo5/yhzeC1gzu9J+efmjf6FrjlP5Mvi6PT8tbAmIwpe6y4NZUXfC4cp3bF7L08Av7E8Lb56fBVdc9aWrGyub2Vc8WRGk1UcZoLKFzGO6DAzH2XMqUe7ZY5qHjqbojGgQXNdwCmUIVhAVjs/XCdd2J48/6PdBf2v0zwqf5x6sSwFgntL7a7+WrmIjXDRQx3aIU79djjL6DvFT1kmB6WN9T3zZAqJ5AXq76taRyPcmNmm3dKThCt34Ns=\rsource: DN42\rdata/person/USMAN-DN42 - contact info.\nperson: Usman\re-mail: usman@email.com\rnic-hdl: USMAN-DN42\rmnt-by: USMAN-MNT\rsource: DN42\rdata/route/172.22.132.160_27 - route for v4.\nroute: 172.22.132.160/27\rorigin: AS4242421869\rmnt-by: USMAN-MNT\rsource: DN42\rdata/route6/fd5f:2bd0:1feb::_48 - route for v6.\nroute6: fd5f:2bd0:1feb::/48\rorigin: AS4242421869\rmax-length: 48\rmnt-by: USMAN-MNT\rsource: DN42\rI then ran the provided scripts to squash, verify and sign (with my public SSH key) my commits.\nOnce I pushed my commit, I created a pull request and waited for it to be approved.  My Routing Daemon. Onto the actual BGP stuff\u0026hellip;\nThe Router. While most DN42 users opt for a Bird/Quagga routing daemon on a VPS, I chose to use my existing Ubiquiti EdgeRouter-X. It\u0026rsquo;s a great router, with a large range of features. See my other post for more info.\nPeering with Kioubit. I peered with the Kioubit Network, as they have automatic peering and a high centrality in the mesh (they have the most neighbours).\nI used Kioubit\u0026rsquo;s automatic peering wizard to register my ASN, WireGuard public key and tunnel IP. This essentially configures their UK BGP router to listen for a WireGuard peer, which has the correct key.\nWireGuard only requires one peer to have a port open, therefore I didn\u0026rsquo;t need to publicly open a port on my router.\nTheir side has also been configured to allow BGP advertisements from my ASN and advertise DN42\u0026rsquo;s prefixes, over the WireGuard tunnel.\n My Side. WireGuard Tunnel. set interfaces wireguard wg4 address 192.168.219.127/32\rset interfaces wireguard wg4 firewall in name DN42_MAIN_IN\rset interfaces wireguard wg4 firewall local name DN42_MAIN_LOCAL\rset interfaces wireguard wg4 mtu 1420\rset interfaces wireguard wg4 peer \u0026lt;peer pubkey\u0026gt; allowed-ips 0.0.0.0/0\rset interfaces wireguard wg4 peer \u0026lt;peer pubkey\u0026gt; endpoint 'uk1.g-load.eu:21869'\rset interfaces wireguard wg4 private-key \u0026lt;my private key\u0026gt;\rset interfaces wireguard wg4 route-allowed-ips false\rWhat this does:\n Creates a virtual interface called wg4. Assigns it the IP address 192.168.219.127/37 (configured in the Kioubit\u0026rsquo;s automated peering). Sets the allowed-ips value to 0.0.0.0/0 - this requests to/from any IP address to traverse the tunnel. Defines the Kioubit\u0026rsquo;s Uk Node\u0026rsquo;s endpoint and port. Sets the route-allowed-ips value to false, so a default route doesn\u0026rsquo;t get added to the route table. Adds the interfaces to the firewall group DN42_IN \u0026amp; DN42_LOCAL more on this later   BGP Peering. set protocols bgp 4242421869 neighbor 172.20.53.104 description kioubit\rset protocols bgp 4242421869 neighbor 172.20.53.104 ebgp-multihop 255\rset protocols bgp 4242421869 neighbor 172.20.53.104 remote-as 4242423914\rset protocols bgp 4242421869 neighbor 172.20.53.104 soft-reconfiguration inbound\rset protocols bgp 4242421869 neighbor 172.20.53.104 update-source 172.22.132.161\rWhat this does:\n Enables the BGP routing daemon with my ASN 4242421869. Sets the remote remote AS, with a neighbour IP as 172.20.43.104(kioubit\u0026rsquo;s IP address in WG tunnel). Sets eBGP Multihop to 255 hops - this is required as the peering is established over a VPN tunnel, not a direct connection.   Other BGP and Routing settings. set protocols bgp 4242421869 network 172.22.132.160/27\rset protocols bgp 4242421869 parameters router-id 172.22.132.161\rset protocols static interface-route 172.20.53.104/32 next-hop-interface wg4\rWhat this does:\n Advertises the 172.22.132.160/27 prefix (my DN42 subnet). Sets the router ID (which is advertised to peers) to 172.22.132.161. Created a static interface route for Kioubit\u0026rsquo;s address 172.20.53.104, via wg4.   Firewall Rules and security. I used firewall rules to limit the traffic between my network and DN42.\nUbiquiti\u0026rsquo;s firewalling works by having different \u0026lsquo;directions\u0026rsquo;. IN and LOCAL.\n  IN Matches on established/related and invalid traffic that is passed through the router (WAN to LAN).\n  LOCAL Matches on established/related and invalid traffic that is destined for the router itself (WAN to LOCAL).\n  DN42_MAIN_IN. set firewall name DN42_MAIN_IN default-action drop\rset firewall name DN42_MAIN_IN rule 1 action accept\rset firewall name DN42_MAIN_IN rule 1 description 'Allow established/related'\rset firewall name DN42_MAIN_IN rule 1 log disable\rset firewall name DN42_MAIN_IN rule 1 protocol all\rset firewall name DN42_MAIN_IN rule 1 state established enable\rset firewall name DN42_MAIN_IN rule 1 state invalid disable\rset firewall name DN42_MAIN_IN rule 1 state new disable\rset firewall name DN42_MAIN_IN rule 1 state related enable\rThe IN ruleset has a default action to drop any packets, and only allow any traffic that is established/related. Meaning only any traffic that is initiated from a device in my LAN (not the router) will be allowed.\nIf I wanted to host any services for any other DN42 members, this is where I would add another rule to allow traffic to a specific host \u0026amp; port. Along with a port forward to bypass NAT.\nDN42_MAIN_LOCAL. set firewall name DN42_MAIN_LOCAL default-action drop\rset firewall name DN42_MAIN_LOCAL rule 1 action accept\rset firewall name DN42_MAIN_LOCAL rule 1 description 'Allow established/related'\rset firewall name DN42_MAIN_LOCAL rule 1 log disable\rset firewall name DN42_MAIN_LOCAL rule 1 protocol all\rset firewall name DN42_MAIN_LOCAL rule 1 state established enable\rset firewall name DN42_MAIN_LOCAL rule 1 state invalid disable\rset firewall name DN42_MAIN_LOCAL rule 1 state new disable\rset firewall name DN42_MAIN_LOCAL rule 1 state related enable\rset firewall name DN42_MAIN_LOCAL rule 2 action accept\rset firewall name DN42_MAIN_LOCAL rule 2 description 'Allow BGP'\rset firewall name DN42_MAIN_LOCAL rule 2 destination port 179\rset firewall name DN42_MAIN_LOCAL rule 2 log disable\rset firewall name DN42_MAIN_LOCAL rule 2 protocol tcp\rThe local ruleset also has the same default action and established/related rule. I also have a rule to allow incoming TCP connections on port 179, for BGP.\nThis is where I would create another rule if I wanted to allow DN42 members to access something directly on the router. For example, SSH for administrative purposes.\n Source NAT. I also implemented NAT so that I can access DN42 from any device in my LAN.\nset service nat rule 5050 description 'source NAT for DN42 Peer Kioubit'\rset service nat rule 5050 log disable\rset service nat rule 5050 outbound-interface wg4\rset service nat rule 5050 outside-address address 172.22.132.162\rset service nat rule 5050 protocol all\rset service nat rule 5050 source\rset service nat rule 5050 type source\rConnections destined for the DN42 prefix, will be NAT\u0026rsquo;ed through the address 172.22.132.162 (one of the IPs in my claimed range).\nFor example, my Raspberry Pi (which is in a local VLAN) can access the DN42 network and run a traceroute to a DN42 IP.\n Maps. At the moment, I have connections with 5 peers. This improves redundancy and provides better access to all areas of the mesh. ","permalink":"https://blog.usman.network/posts/dn42-bgp/","summary":"What is DN42? DN42 is a big network, which employs WAN technologies (BGP, whois database, DNS, etc) to create an internet like mesh.\nMembers connect to each other using VPN tunnels (GRE, OpenVPN, WireGuard, IPsec) and exchange routes via BGP.\nDN42 currently has 410 nodes/users, advertising ~600 prefixes. realtime map\n Why DN42? DN42 allows you to experiment with mentioned internet technologies, without the logistical difficulties and high expenses of registering with real AS registries, on the live internet.","title":"DN42 Part 1: Connecting to the DN42 BGP Mesh"},{"content":"What is Wireguard? WireGuard is an extremely simple yet fast and modern VPN that utilizes modern cryptography. It aims to be faster, simpler, leaner, and more useful than alternatives such as IPsec \u0026amp; OpenVPN.\nWireGuard\u0026rsquo;s codebase has only 4,000 lines of code, which is considerably less than OpenVPN\u0026rsquo;s, which has 600,000.\n WireGuard\u0026rsquo;s Performance WireGuard\u0026rsquo;s speed and elegance are the main reasons for its popularity, it is significantly faster than OpenVPN \u0026amp; IPsec - in terms of raw throughput, authentication speed and latency.\nData from WireGuard.com\n How WireGuard Works At a fundamental level, WireGuard works by creating an interface and dictating some details such as:\n Your private key Your peer\u0026rsquo;s pub key Your peer\u0026rsquo;s endpoint \u0026amp; port  Some complex mathematical authentication happens, and you have a UDP tunnel which packets can traverse.\n Ubiquiti EdgeRouter Ubiquiti\u0026rsquo;s EdgeRouter lineup is a relatively inexpensive platform which provides a large range of features. The EdgeRouter-X costs Â£50, and has some enterprise grade features and dynamic routing protocols such as BGP, MPLS, OSPF, QoS, RIP, DNAT, SNAT, DPI, etc.\nThe EdgeRouter devices come with Ubiquiti\u0026rsquo;s Debian Linux based EdgeOS, which is a fork of Vyatta/Vyos.\nThere is a Web UI for basic configuration, and a Juniper-style CLI for more advanced functions.\n WireGuard Installation on ER-X 1. Download the .deb for your EdgeRouter variant and software version from the WireGuard github repository. For example, on an ER-X with v2 software, use curl in this example:\nuser@ER-X:~$ curl -OL https://github.com/WireGuard/wireguard-vyatta-ubnt/releases/download/1.0.20210606-2/e50-v2-v1.0.20210606-v1.0.20210914.deb\rYou should then be able to see the .deb file in your home directory.\nuser@ER-X:~$ ls -la\rtotal 176\rdrwxr-xr-x 4 user users 800 Oct 20 11:12 .\rdrwxr-xr-x 1 root root 288 Jun 23 20:41 ..\r-rw-r--r-- 1 user users 220 May 15 2017 .bash_logout\r-rw-r--r-- 1 user users 192 May 11 14:30 .bashrc\r-rw------- 1 user users 280 Oct 21 17:40 .history\r-rw-r--r-- 1 user users 675 May 15 2017 .profile\rdrwxr-x--- 2 user users 304 Aug 16 18:28 .ssh\r-rw-r--r-- 1 user users 153820 Oct 17 16:14 e50-v2-v1.0.20210606-v1.0.20210914.deb\rBefore installation, ensure you have the downloaded the correct fie for your Edgerouter variant and software version.\n2. Install the .deb file. To install the package, use the dpkg command.\n$ sudo dpkg -i e50-v2-v1.0.20210606-v1.0.20210914.deb\r3. To verify installation, Wireguard should appear in the show interfaces menu. user@ER-X:~$ show interfaces wireguard\rPossible completions:\r\u0026lt;Enter\u0026gt; Execute the current command\rallowed-ips Show wireguard interface allowed ips\rdetail Show detailed WireGuard interface information\rendpoints Show wireguard interface endpoints\rfwmark Show wireguard interface fwmark\rlatest-handshakes Show wireguard interface latest-handshakes\rlisten-port Show wireguard interface listen port\rpeers Show wireguard interface peers\rpersistent-keepalive Show wireguard interface persistent keepalive\rpreshared-keys Show wireguard interface preshared keys\rprivate-key Show wireguard interface private key\rpublic-key Show wireguard interface public key\rtransfer Show wireguard interface transfer statistics\rwg0 Show specified wireguard interface information\r WireGuard Configuration on ER-X 1. Generating Server Key Pair First we will need to generate a key pair for the wireguard server.\n# Create a folder for the server's keys\ruser@ER-X:~$ mkdir server_keys\r# Navigate to that dir\ruser@ER-X:~$ cd server_keys\r# Currently in the server_keys directory\ruser@ER-X:~/server_keys$\r# Generate the keys\ruser@ER-X:~/server_keys$ wg genkey | tee privatekey | wg pubkey \u0026gt; publickey\r# ls command shows the generated keys\ruser@ER-X:~/server_keys$ ls\rpubklickey privatekey\r# Navigate back to the home directory\ruser@ER-X:~/server_keys$ cd ..\r# Confirm this using pwd\ruser@ER-X:~$ pwd\r/home/user\rYou can use the cat linux command to see the contents of the keyfile.\nuser@ER-X:~/server$ cat public\roUCXb+z4M6d0HCdJq2MB9WQLS8S1JsUYNM3vQTAkFmU=\r2. Generating the my_phone Peer Key Pair The peer key pair can be generated on any device, however it\u0026rsquo;s more convenient to store all the keys on the router.\n# Create a folder for the peer's keys\ruser@ER-X:~$ mkdir my_phone\r# Navigate to that dir\ruser@ER-X:~$ cd my_phone\r# Generate a key pair for the my_phone peer, in the my_phone directory\ruser@ER-X:~/server_keys/$ wg genkey | tee privatekey | wg pubkey \u0026gt; publickey\rYou then should have two directories; one called server_keys and my_phone.\nuser@ER-X:~$ ls -la\rdrwxr-xr-x 4 user users 800 Oct 20 11:12 .\rdrwxr-xr-x 1 root root 288 Jun 23 20:41 ..\r-rw-r--r-- 1 user users 220 May 15 2017 .bash_logout\r-rw-r--r-- 1 user users 192 May 11 14:30 .bashrc\r-rw------- 1 user users 280 Oct 21 17:40 .history\r-rw-r--r-- 1 user users 675 May 15 2017 .profile\rdrwxr-x--- 2 user users 304 Aug 16 18:28 .ssh\rdrwxr-x--- 2 user users 304 Aug 16 18:28 my_phone\rdrwxr-x--- 2 user users 304 Aug 16 18:28 server_keys\r-rw-r--r-- 1 user users 153820 Oct 17 16:14 e50-v2-v1.0.20210606-v1.0.20210914.deb\r3. wg0 Interface Configuration # Enter configure mode\rconfigure\r# The location of the server's private key, previously generated\r[edit]\ruser@ER-X$ set interfaces wireguard wg0 private-key /home/user/server/privatekey\r# Creates the Gateway IP for the VPN and the subnet\r# This subnet can be any private IP range, through check for conflicts user@ER-X$ set interfaces wireguard wg0 address 10.6.69.1/24\r# Creates entries in the route table for the VPN subnet\ruser@ER-X$ set interfaces wireguard wg0 route-allowed-ips true\r# Port for WG (that peers will use)\ruser@ER-X$ set interfaces wireguard wg0 listen-port 51820\ruser@ER-X$ commit ; save\r4. Adding peers to the wg0 Interface # Remote User Peer\ruser@ER-X$ set interfaces wireguard wg0 peer /home/user/my_phone/pubkey\ruser@ER-X$ set interfaces wireguard wg0 peer /home/user/my_phone/pubkey allowed-ips 10.6.69.2/32\ruser@ER-X$ commit ; save\r5. Poking a hole in the firewall for WireGuard # Creates an accept rule in the WAN_LOCAL list (WAN_LOCAL - wan to router)\r# Accepts all incoming UDP connections, from port 51820\ruser@ER-X$ set firewall name WAN_LOCAL rule 20 action accept\ruser@ER-X$ set firewall name WAN_LOCAL rule 20 protocol udp\ruser@ER-X$ set firewall name WAN_LOCAL rule 20 destination port 51820\ruser@ER-X$ set firewall name WAN_LOCAL rule 20 description 'WireGuard'\rcommit ; save\rOnce this is done, your wg0 interface and firewall configuration should look something like this.\nuser@ER-X$ show configuration\r}\r}\rwireguard wg0 {\raddress 10.6.69.1/24\rdescription WG_VPN\rlisten-port 51820\rpeer XzXsLlbdFDGzK10jFxySz3Qbk8ekY7YsASPAb+QprAc= {\rallowed-ips 10.6.69.2/32\rdescription my_phone\r}\rprivate-key ****************\rroute-allowed-ips true\r}\r}\r}\rrule 20 {\raction accept\rdescription WG_IN\rdestination {\rport 51820\r}\rlog enable\rprotocol udp\rsource {\r}\r}\r6. Constructing the Config on the peer side The peer side needs a few pieces of information to create the tunnel:\n The server\u0026rsquo;s public key The server\u0026rsquo;s endpoint (public IP address, or DNS record) The peer\u0026rsquo;s private key The peer\u0026rsquo;s IP address in the VPN subnet (the allowed IPs value set on the server)  Therefore, the previously generated my_phone private key AND the server\u0026rsquo;s public key, should be copied to the peer device.\nCreate a file on the peer, with the file extension as .conf.\n[Interface]\rPrivateKey = \u0026lt;my_phone private key\u0026gt;\rListenPort = 51820\rAddress = 10.6.69.3/32 # The allowed IPs value set on the server\rDNS = 1.1.1.1 # Optional\r[Peer]\rPublicKey = \u0026lt;pubkey of server\u0026gt;\rAllowedIPs = 0.0.0.0/0 # Currently set as a wildcard to route all packets through VPN\rEndpoint = server.com:51820 # PubIP or DNS record of server\rThis can then be imported to the peer of your choice.\nIn the Windows peer, create a new tunnel and paste the config in.\n7. You then should be able to connect to the VPN The latest handshake and transferred traffic metric can be a useful troubleshooting indicator.  More peers can be added by repeating the same steps (generating keys, allowing them in the wg0 interface and constructing the peer config).\n Split Tunneling Split tunneling is used to send traffic, only destined for a specific IP range, down the tunnel.\nSplit tunneling can be useful when you want to access devices on the other end of the VPN tunnel, but don\u0026rsquo;t want to tunnel all of your normal traffic (e.g. web browsing).\nThis can be achieved easily by changing the allowedIPs subnet of the peer side.\nAt the moment, it is set to a wildcard:\nAllowedIPs = 0.0.0.0/0\rBut it can be modified, e.g. if you only want to route packets for a few specific subnets:\nAllowedIPs = 10.0.10.0/24, 172.16.0.0/26\r Diagnostics The sudo wg command can be used to used to see diagnostic data, useful for troubleshooting.\n Conclusion Thats it! You should now have a working Wireguard VPN tunnel on your EdgeRouter.\n","permalink":"https://blog.usman.network/posts/wireguard-vpn-on-a-ubiquiti-edgerouter/","summary":"What is Wireguard? WireGuard is an extremely simple yet fast and modern VPN that utilizes modern cryptography. It aims to be faster, simpler, leaner, and more useful than alternatives such as IPsec \u0026amp; OpenVPN.\nWireGuard\u0026rsquo;s codebase has only 4,000 lines of code, which is considerably less than OpenVPN\u0026rsquo;s, which has 600,000.\n WireGuard\u0026rsquo;s Performance WireGuard\u0026rsquo;s speed and elegance are the main reasons for its popularity, it is significantly faster than OpenVPN \u0026amp; IPsec - in terms of raw throughput, authentication speed and latency.","title":"Wireguard VPN on a Ubiquiti EdgeRouter"}]