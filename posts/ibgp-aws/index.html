<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>DN42 Part 2: Conecting an AWS VPS to DN42, using iBGP and WireGuard. | UsmanNet</title>
<meta name="keywords" content="" />
<meta name="description" content="I recently connected to the DN42 BGP mesh, a big network which employs WAN technologies to create an internet like mesh. Read my first most for more info on DN42.
In this post, I&rsquo;ll go over how I:
 Provisioned an AWS Linux VPS. Created a WireGuard Site2Site VPN Connection between my Ubiquiti EdgeRouter and VPS. Utilized the BIRD internet routing daemon to handle internal BGP routing over that VPN connection.">
<meta name="author" content="Usman">
<link rel="canonical" href="https://blog.usman.network/posts/ibgp-aws/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.5a00d27b9099d0e99da2f0a091cdc62b9d27d50a94a4afe94f3cc721fe59d84e.css" integrity="sha256-WgDSe5CZ0OmdovCgkc3GK50n1QqUpK/pTzzHIf5Z2E4=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://blog.usman.network/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.usman.network/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.usman.network/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://blog.usman.network/apple-touch-icon.png">
<link rel="mask-icon" href="https://blog.usman.network/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.88.1" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KWB2M6CZK2"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-KWB2M6CZK2', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="DN42 Part 2: Conecting an AWS VPS to DN42, using iBGP and WireGuard." />
<meta property="og:description" content="I recently connected to the DN42 BGP mesh, a big network which employs WAN technologies to create an internet like mesh. Read my first most for more info on DN42.
In this post, I&rsquo;ll go over how I:
 Provisioned an AWS Linux VPS. Created a WireGuard Site2Site VPN Connection between my Ubiquiti EdgeRouter and VPS. Utilized the BIRD internet routing daemon to handle internal BGP routing over that VPN connection." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.usman.network/posts/ibgp-aws/" />
<meta property="og:image" content="https://blog.usman.network/images/iBGP-AWS/map.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-10T20:58:53&#43;00:00" />
<meta property="article:modified_time" content="2022-01-10T20:58:53&#43;00:00" /><meta property="og:site_name" content="Usman" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://blog.usman.network/images/iBGP-AWS/map.png" />
<meta name="twitter:title" content="DN42 Part 2: Conecting an AWS VPS to DN42, using iBGP and WireGuard."/>
<meta name="twitter:description" content="I recently connected to the DN42 BGP mesh, a big network which employs WAN technologies to create an internet like mesh. Read my first most for more info on DN42.
In this post, I&rsquo;ll go over how I:
 Provisioned an AWS Linux VPS. Created a WireGuard Site2Site VPN Connection between my Ubiquiti EdgeRouter and VPS. Utilized the BIRD internet routing daemon to handle internal BGP routing over that VPN connection."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://blog.usman.network/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "DN42 Part 2: Conecting an AWS VPS to DN42, using iBGP and WireGuard.",
      "item": "https://blog.usman.network/posts/ibgp-aws/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "DN42 Part 2: Conecting an AWS VPS to DN42, using iBGP and WireGuard.",
  "name": "DN42 Part 2: Conecting an AWS VPS to DN42, using iBGP and WireGuard.",
  "description": "I recently connected to the DN42 BGP mesh, a big network which employs WAN technologies to create an internet like mesh. Read my first most for more info on DN42.\nIn this post, I\u0026rsquo;ll go over how I:\n Provisioned an AWS Linux VPS. Created a WireGuard Site2Site VPN Connection between my Ubiquiti EdgeRouter and VPS. Utilized the BIRD internet routing daemon to handle internal BGP routing over that VPN connection.",
  "keywords": [
    
  ],
  "articleBody": "I recently connected to the DN42 BGP mesh, a big network which employs WAN technologies to create an internet like mesh. Read my first most for more info on DN42.\nIn this post, I’ll go over how I:\n Provisioned an AWS Linux VPS. Created a WireGuard Site2Site VPN Connection between my Ubiquiti EdgeRouter and VPS. Utilized the BIRD internet routing daemon to handle internal BGP routing over that VPN connection.  The end goal was to have the AWS VPS be able to access the DN42 mesh (using iBGP) via my EdgeRouter, and then through the EdgeRouter’s 5 eBGP peerings (see diagram).\nProvisioning the AWS VPS After creating an AWS free tier account, I chose to use a new Debian Instance. Any modern Linux distribution (with BIRD, WireGuard and a Public IP address) should suffice.\nI selected the free tier eligible t2.micro. It comes with a 2.5Ghz vCPU, 1GB of RAM and 7GB of storage, which is plenty for a BGP router with a route table the size of DN42’s (~600 prefixes). One I launched the VPS, I connected to it using my generated AWS SSH private key.\nssh -i C:\\Users\\Usman\\.ssh\\AWS_Access.pem admin@AWS-VPS root@AWS-VPS:/home/admin# neofetch _,met$$$$$gg. root@AWS-VPS ,g$$$$$$$$$$$$$$$P. -------------------- ,g$$P\" \"\"\"Y$$.\". OS: Debian GNU/Linux 10 (buster) x86_64 ,$$P' `$$$. Host: HVM domU 4.2.amazon ',$$P ,ggs. `$$b: Kernel: 4.19.0-18-cloud-amd64 `d$$' ,$P\"' . $$$ Uptime: 16 hours $$P d$' , $$P Packages: 452 (dpkg) $$: $$. - ,d$$' Shell: bash 5.0.3 $$; Y$b._ _,d$P' CPU: Intel Xeon E5-2686 v4 (1) @ 2.300GHz Y$$. `.`\"Y$$$$P\"' GPU: Cirrus Logic GD 5446 `$$b \"-.__ Memory: 74MiB / 987MiB `Y$$ `Y$$. `$$b. `Y$$b. `\"Y$b._ `\"\"\" Installing the required packages Next, I upgraded the system packages, installed WireGuard and the BIRD routing daemon.\nroot@AWS-VPS:~$ sudo apt update \u0026\u0026 sudo apt upgrade -y root@AWS-VPS:~$ sudo apt install wireguard root@AWS-VPS:~$ sudo apt install bird  Establishing the WireGuard VPN Tunnel Generating Key Pairs After the installation, I generated WireGuard Public and Private Key Pairs, on my EdgeRouter and VPS. Where each peer has public/private key pair, and only needs to know the peer’s public key.\nOn the EdgeRouter:\nusman@ER-X:~$ mkdir /home/usman/wgconfs/AWS usman@ER-X:~$ cd /home/usman/wgconfs/AWS usman@ER-X:~/wgconfs/AWS$ wg genkey | tee privatekey | wg pubkey  publickey usman@ER-X:~/wgconfs/AWS$ ls private public On the VPS:\nroot@AWS-VPS:~$ cd /etc/wireguard/ root@AWS-VPS:/etc/wireguard$ wg genkey | tee privatekey | wg pubkey  publickey usman@AWS-VPS:~/etc/wireguard$ ls private public  WireGuard on the EdgeRouter set interfaces wireguard wg67 address 10.132.0.2/30 set interfaces wireguard wg67 mtu 1420 set interfaces wireguard wg67 peer LHv3equY4NyDeLVCY1+P5IrCA23+bYLixB18ehHjzzM= allowed-ips 0.0.0.0/0 set interfaces wireguard wg67 peer LHv3equY4NyDeLVCY1+P5IrCA23+bYLixB18ehHjzzM= endpoint 'aws.vps.com:51823' set interfaces wireguard wg67 private-key /home/usman/wgconfs/privatekey set interfaces wireguard wg67 route-allowed-ips false What this does:\n Creates a WireGuard Interface, called wg67 with an IP address of 10.132.0.2 Sets the MTU to 1420 Creates a peer with the public key of LHv3equY4NyDeLVCY1+P5IrCA23+bYLixB18ehHjzzM= Allows any ip address to flow over the tunnel. Specifies the public IP endpoint of the AWS VPS. Associates the previously generated private key with the wg67 interface. Set the route-allowed-ips value to false, as that would create a default route via the VPS.  Allowing WireGuard through the EdgeRouter’s firewall set firewall name WAN_LOCAL rule 25 action accept set firewall name WAN_LOCAL rule 25 description iBGP-AWS set firewall name WAN_LOCAL rule 25 destination port 51823 set firewall name WAN_LOCAL rule 25 log enable set firewall name WAN_LOCAL rule 25 protocol udp What this does:\n Creates an accept rule in the WAN_LOCAL rule set, which regulates traffic from the WAN interface, to the router. Accepts all incoming UDP connections on port 51823, from the AWS VPS.   WireGuard on the AWS Debian VPS WireGuard on Linux is similar to the EdgeRouter’s config.\nip link add dev wg0 type wireguard ip address add dev wg0 10.132.0.1/30 wg set wg0 listen-port 51823 private-key /etc/wireguard/privatekey peer  allowed-ips 0.0.0.0/0 endpoint :51823 ip link set up dev wg0 ip addr add 172.22.132.169/32 dev lo What this does:\n Creates an interface called wg0, with the type wireguard. Assigns the address 10.132.0.1/30 to the wg0 interface. Sets the server listen port to 51823. Sets the privatekey to the location of the previously generated private key. Allows any ip address over the tunnel. Specifies the public IP and port of the EdgeRouter peer.  Allowing WireGuard through AWSs Security Group I also modified the VPS’s security group, so that it allows incoming udp connections on port 51823, from the EdgeRouter.\n Testing Reachability After configuring the Firewall Rules, I was able to ping between the VPS and EdgeRouter, over the WireGuard VPN Interface.\nFrom the EdgeRouter, to the VPS:\nusman@ER-X:~$ ping 10.132.0.1 PING 10.132.0.1 (10.132.0.1) 56(84) bytes of data. 64 bytes from 10.132.0.1: icmp_seq=1 ttl=64 time=31.4 ms 64 bytes from 10.132.0.1: icmp_seq=2 ttl=64 time=31.5 ms 64 bytes from 10.132.0.1: icmp_seq=3 ttl=64 time=35.0 ms 64 bytes from 10.132.0.1: icmp_seq=4 ttl=64 time=34.3 ms 64 bytes from 10.132.0.1: icmp_seq=5 ttl=64 time=31.8 ms From the VPS to the EdgeRouter:\nadmin@AWS-VPS:~$ ping 10.132.0.2 PING 10.132.0.2 (10.132.0.2) 56(84) bytes of data. 64 bytes from 10.132.0.2: icmp_seq=1 ttl=64 time=39.4 ms 64 bytes from 10.132.0.2: icmp_seq=2 ttl=64 time=34.7 ms 64 bytes from 10.132.0.2: icmp_seq=3 ttl=64 time=34.8 ms 64 bytes from 10.132.0.2: icmp_seq=4 ttl=64 time=29.5 ms 64 bytes from 10.132.0.2: icmp_seq=5 ttl=64 time=28.9 ms The latency ranges from 30-40 ms, which perfectly acceptable for a VPN connection over the internet.\nWireGuard also provides some diagnostic data (e.g. data usage, latest handshake etc.).\nOn the EdgeRouter:\nusman@ER-X:~$ sudo wg interface: wg67 public key: P1FrJ1IpHCFX3Tk/4aFxbrCbD4VDefwHaieVWDWoXx0= private key: (hidden) listening port: 51650 peer: LHv3equY4NyDeLVCY1+P5IrCA23+bYLixB18ehHjzzM= endpoint: AWS-pub.ip:51823 allowed ips: 0.0.0.0/0 latest handshake: 46 seconds ago transfer: 252.68 MiB received, 30.28 MiB sent On the VPS:\nroot@AWS-VPS:~# wg interface: wg67 public key: LHv3equY4NyDeLVCY1+P5IrCA23+bYLixB18ehHjzzM= private key: (hidden) listening port: 51823 peer: P1FrJ1IpHCFX3Tk/4aFxbrCbD4VDefwHaieVWDWoXx0= endpoint: edgerouter-pub.ip:51650 allowed ips: 0.0.0.0/0 latest handshake: 46 seconds ago transfer: 30.21 MiB received, 252.70 MiB sent  iBGP Configuration Once the VPN was up, I set about creating a internal BGP peering between the EdgeRouter and VPS (so that the VPS could reach DN42, via the EdgeRouter’s upstream transit peers).\nWhy BIRD Internet Routing Daemon? I chose to use the free and open-source BIRD routing daemon as its widely used in the DN42 mesh and on the real internet.\nNetflix proudly uses BIRD to run their global CDN backbone, which handles ~100Tbps at peak. So its probably fine for DN42’s few hundred routes.\nBIRD BGP Configuration on the VPS Upon installation, BIRD created a template configuration file in /etc/bird/bird.conf. I just had to add some parameters regarding my own BGP peering and WireGuard tunnel.\nroot@AWS-VPS:/etc/bird# vim bird.conf router id 172.22.132.169; protocol kernel { scan time 20; import none; export filter { if source = RTS_STATIC then reject; krt_prefsrc = 172.22.132.169; accept; }; }; protocol device { scan time 60; } protocol direct { interface \"*\"; } protocol bgp { description \"BIRD BGP CONFIG\"; local as 4242421869; neighbor 10.132.0.2 as 4242421869; graceful restart; import all; export all; } What this does:\n Sets the router ID to 172.22.132.169 - an IP address in my designated DN42 range (claimed by my ASN). Creates a kernel table. The Kernel protocol is not a real routing protocol. Instead of communicating with other routers in the network, it performs synchronization of BIRD’s routing tables with the OS kernel. Creates protocol direct and protocol device, which are BIRD specific settings. Initialises the BGP protocol on BIRD, with the local ASN of 4242421869. Sets the neighbour remote ASN to 4242421869 via 10.132.0.2 (the WireGuard IP address for the EdgeRouter). The use of the same local and remote ASN triggers internal BGP, as opposed to external BGP.  BGP Configuration for the EdgeRouter BGP on the EdgeRouter similar to BIRD.\nset protocols bgp 4242421869 parameters router-id 172.22.132.161 set protocols bgp 4242421869 neighbor 10.132.0.1 description iBGP set protocols bgp 4242421869 neighbor 10.132.0.1 nexthop-self set protocols bgp 4242421869 neighbor 10.132.0.1 remote-as 4242421869 set protocols bgp 4242421869 neighbor 10.132.0.1 soft-reconfiguration inbound What this does:\n Creates an instance of BGP, with my local ASN (4242421869) and router id 172.22.132.161. Sets the neighbour remote ASN to 4242421869 via 10.132.0.1 (the WireGuard IP address for the AWS VPS). Enables next-hop self, which forces the router to do a recursive lookup in order to determine which egress interface should be used to send the packets out. Enables soft-reconfiguration inbound.   Verifying the iBGP Peering On the EdgeRouter, the BGP state had changed to “Established”, its announcing 463 routes to the VPS, at IP 10.132.0.1 (the WireGuard peer IP).\nusman@ER-X:~$ show ip bgp neighbors 10.132.0.1 BGP neighbor is 10.132.0.1, remote AS 4242421869, local AS 4242421869, internal link BGP version 4, remote router ID 172.22.132.169 BGP state = Established, up for 17:26:23 Last read 17:26:23, hold time is 180, keepalive interval is 60 seconds Neighbor capabilities: Route refresh: advertised and received (new) 4-Octet ASN Capability: advertised and received Address family IPv4 Unicast: advertised and received Received 5794 messages, 21 notifications, 0 in queue Sent 20084 messages, 12 notifications, 0 in queue Route refresh request: received 0, sent 0 Minimum time between advertisement runs is 5 seconds For address family: IPv4 Unicast BGP table version 43303, neighbor version 43303 Index 0, Offset 0, Mask 0x1 Graceful restart: received Inbound soft reconfiguration allowed NEXT_HOP is always this router Community attribute sent to this neighbor (both) 0 accepted prefixes 463 announced prefixes Connections established 23; dropped 22 Local host: 10.132.0.2, Local port: 179 Foreign host: 10.132.0.1, Foreign port: 54586 Nexthop: 10.132.0.2 Nexthop global: :: Nexthop local: :: BGP connection: non shared network Last Reset: 17:26:23, due to BGP Notification sent Notification Error Message: (Cease/Administratively Reset.) On the AWS VPS:\nAfter entering the birdc shell on the VPS, I could also see that the BGP state had been established.\nIts accepting those 463 routes that the EdgeRouter advertised, over the WireGuard tunnel (IP address 10.132.0.2).\nroot@AWS-VPS:~# birdc bird show protocols bgp1 bgp1 BGP master up 16:37:06 Established Description: BIRD BGP CONFIG Preference: 100 Input filter: ACCEPT Output filter: REJECT Routes: 463 imported, 0 exported, 463 preferred Route change stats: received rejected filtered ignored accepted Import updates: 466 0 0 0 466 Import withdraws: 0 0 --- 0 0 Export updates: 469 466 3 --- 0 Export withdraws: 0 --- --- --- 0 BGP state: Established Neighbor address: 10.132.0.2 Neighbor AS: 4242421869 Neighbor ID: 172.22.132.161 Neighbor caps: refresh AS4 Session: internal multihop AS4 Source address: 10.132.0.1 Hold timer: 147/180 Keepalive timer: 40/60 bird  Inspecting VPS’s Route Table The AWS VPS now has DN42’s prefixes in its kernel route table.\nDN42 prefixes (172.20.0.0/14) have a gateway of the EdgeRouter, (over the WireGuard VPN tunnel).\nroute -n showing a subset of the VPS’s route table:\nroot@AWS-VPS:~# route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 172.31.0.1 0.0.0.0 UG 0 0 0 eth0 172.20.0.53 10.132.0.2 255.255.255.255 UGH 0 0 0 wg0 172.20.1.0 10.132.0.2 255.255.255.0 UG 0 0 0 wg0 172.20.4.32 10.132.0.2 255.255.255.240 UG 0 0 0 wg0 172.20.4.96 10.132.0.2 255.255.255.248 UG 0 0 0 wg0 172.20.4.104 10.132.0.2 255.255.255.248 UG 0 0 0 wg0 172.20.6.224 10.132.0.2 255.255.255.248 UG 0 0 0 wg0 172.20.6.248 10.132.0.2 255.255.255.248 UG 0 0 0 wg0 172.20.8.0 10.132.0.2 255.255.254.0 UG 0 0 0 wg0 172.20.12.192 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 172.20.14.32 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 172.20.14.64 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 172.20.14.192 10.132.0.2 255.255.255.192 UG 0 0 0 wg0 172.20.15.96 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 172.20.16.0 10.132.0.2 255.255.255.128 UG 0 0 0 wg0 172.20.16.128 10.132.0.2 255.255.255.128 UG 0 0 0 wg0 172.20.18.64 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 172.20.18.224 10.132.0.2 255.255.255.240 UG 0 0 0 wg0 172.20.19.64 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 172.20.20.96 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 172.20.28.224 10.132.0.2 255.255.255.224 UG 0 0 0 wg0 Ping Testing Success! Pinging a device inside the DN42 range 172.23.0.80 confirms that I have access to the DN42 network.\nroot@ip-172-31-0-189:~# ping 172.23.0.80 PING 172.23.0.80 (172.23.0.80) 56(84) bytes of data. 64 bytes from 172.23.0.80: icmp_seq=1 ttl=60 time=69.3 ms 64 bytes from 172.23.0.80: icmp_seq=2 ttl=60 time=72.7 ms 64 bytes from 172.23.0.80: icmp_seq=3 ttl=60 time=71.7 ms 64 bytes from 172.23.0.80: icmp_seq=4 ttl=60 time=83.8 ms 64 bytes from 172.23.0.80: icmp_seq=5 ttl=60 time=74.5 ms Traceroute Testing A traceroute to 172.23.0.80 confirms that the packets are flowing:\n First through the Ubiquiti EdgeRouter 10.132.0.2 over the WG VPN tunnel Next through the EdgeRouter’s eBGP peering with ‘highdef’ 172.20.229.116 Through the DN42 network And finally reaches its destination in 5 total hops.  root@AWS-VPS:~# traceroute 172.23.0.80 traceroute to 172.23.0.80 (172.23.0.80), 30 hops max, 60 byte packets 1 10.132.0.2 33.135 ms 33.105 ms 33.088 ms 2 172.20.229.116 52.967 ms 52.948 ms 52.932 ms 3 172.20.129.187 60.474 ms 60.459 ms 60.438 ms 4 172.20.129.169 73.126 ms 73.102 ms 78.113 ms 5 172.23.0.80 78.097 ms 78.078 ms 78.061 ms What Next? In the future, I’ll probably launch another VPS, create more BGP peering, but install everything automatically with Ansible.\n",
  "wordCount" : "2116",
  "inLanguage": "en",
  "image":"https://blog.usman.network/images/iBGP-AWS/map.png","datePublished": "2022-01-10T20:58:53Z",
  "dateModified": "2022-01-10T20:58:53Z",
  "author":{
    "@type": "Person",
    "name": "Usman"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.usman.network/posts/ibgp-aws/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "UsmanNet",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.usman.network/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">

            
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KWB2M6CZK2"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-KWB2M6CZK2', { 'anonymize_ip': false });
}
</script>

            
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-KWB2M6CZK2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


            <a href="https://blog.usman.network/" accesskey="h" title="UsmanNet (Alt + H)">UsmanNet</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.usman.network/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://blog.usman.network/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://blog.usman.network/contact/" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://blog.usman.network/">Home</a>&nbsp;»&nbsp;<a href="https://blog.usman.network/posts/">Posts</a></div>
    <h1 class="post-title">
      DN42 Part 2: Conecting an AWS VPS to DN42, using iBGP and WireGuard.
    </h1>
    <div class="post-meta">10 January, 2022&nbsp;·&nbsp;10 min&nbsp;·&nbsp;Usman
</div>
  </header> 
<figure class="entry-cover"><img loading="lazy" src="https://blog.usman.network/images/iBGP-AWS/map.png" alt="alt">
        <p>Overview</p>
</figure><div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#provisioning-the-aws-vps" aria-label="Provisioning the AWS VPS">Provisioning the AWS VPS</a></li>
                <li>
                    <a href="#installing-the-required-packages" aria-label="Installing the required packages">Installing the required packages</a></li>
                <li>
                    <a href="#establishing-the-wireguard-vpn-tunnel" aria-label="Establishing the WireGuard VPN Tunnel">Establishing the WireGuard VPN Tunnel</a><ul>
                        
                <li>
                    <a href="#generating-key-pairs" aria-label="Generating Key Pairs">Generating Key Pairs</a></li></ul>
                </li>
                <li>
                    <a href="#wireguard-on-the-edgerouter" aria-label="WireGuard on the EdgeRouter">WireGuard on the EdgeRouter</a><ul>
                        
                <li>
                    <a href="#allowing-wireguard-through-the-edgerouters-firewall" aria-label="Allowing WireGuard through the EdgeRouter&amp;rsquo;s firewall">Allowing WireGuard through the EdgeRouter&rsquo;s firewall</a></li></ul>
                </li>
                <li>
                    <a href="#wireguard-on-the-aws-debian-vps" aria-label="WireGuard on the AWS Debian VPS">WireGuard on the AWS Debian VPS</a><ul>
                        
                <li>
                    <a href="#allowing-wireguard-through-awss-security-group" aria-label="Allowing WireGuard through AWSs Security Group">Allowing WireGuard through AWSs Security Group</a></li>
                <li>
                    <a href="#testing-reachability" aria-label="Testing Reachability">Testing Reachability</a></li></ul>
                </li>
                <li>
                    <a href="#ibgp-configuration" aria-label="iBGP Configuration">iBGP Configuration</a><ul>
                        
                <li>
                    <a href="#why-bird-internet-routing-daemon" aria-label="Why BIRD Internet Routing Daemon?">Why BIRD Internet Routing Daemon?</a></li>
                <li>
                    <a href="#bird-bgp-configuration-on-the-vps" aria-label="BIRD BGP Configuration on the VPS">BIRD BGP Configuration on the VPS</a></li>
                <li>
                    <a href="#bgp-configuration-for-the-edgerouter" aria-label="BGP Configuration for the EdgeRouter">BGP Configuration for the EdgeRouter</a></li></ul>
                </li>
                <li>
                    <a href="#verifying-the-ibgp-peering" aria-label="Verifying the iBGP Peering">Verifying the iBGP Peering</a><ul>
                        
                <li>
                    <a href="#inspecting-vpss-route-table" aria-label="Inspecting VPS&amp;rsquo;s Route Table">Inspecting VPS&rsquo;s Route Table</a></li>
                <li>
                    <a href="#ping-testing" aria-label="Ping Testing">Ping Testing</a></li>
                <li>
                    <a href="#traceroute-testing" aria-label="Traceroute Testing">Traceroute Testing</a></li></ul>
                </li>
                <li>
                    <a href="#what-next" aria-label="What Next?">What Next?</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>I recently connected to the DN42 BGP mesh, a big network which employs WAN technologies to create an internet like mesh.
<a href="https://blog.usman.network/posts/dn42-bgp/"><em>Read my first most for more info on DN42.</em></a></p>
<p>In this post, I&rsquo;ll go over how I:</p>
<ul>
<li>Provisioned an AWS Linux VPS.</li>
<li>Created a WireGuard Site2Site VPN Connection between my Ubiquiti EdgeRouter and VPS.</li>
<li>Utilized the BIRD internet routing daemon to handle internal BGP routing over that VPN connection.</li>
</ul>
<p>The end goal was to have the AWS VPS be able to access the DN42 mesh (using iBGP) via my EdgeRouter, and then through the EdgeRouter&rsquo;s 5 eBGP peerings (see  diagram).</p>
<h2 id="provisioning-the-aws-vps">Provisioning the AWS VPS<a hidden class="anchor" aria-hidden="true" href="#provisioning-the-aws-vps">#</a></h2>
<p><img loading="lazy" src="/images/iBGP-AWS/cloudmeme.jpg" alt="The Cloud Business"  title="The Cloud Business"  />
</p>
<p>After creating an AWS free tier account, I chose to use a new Debian Instance. Any modern Linux distribution (with BIRD, WireGuard and a Public IP address) should suffice.</p>
<p><img loading="lazy" src="/images/iBGP-AWS/debian.PNG" alt="Debian Image"  title="Debian Image"  />
</p>
<p>I selected the free tier eligible <code>t2.micro</code>. It comes with a 2.5Ghz vCPU, 1GB of RAM and 7GB of storage, which is plenty for a BGP router with a route table the size of DN42&rsquo;s (~600 prefixes).
<img loading="lazy" src="/images/iBGP-AWS/debian-free-tier.PNG" alt="Debian Image"  title="Debian Image"  />
</p>
<p>One I launched the VPS, I connected to it using my generated AWS SSH private key.</p>
<pre tabindex="0"><code>ssh -i  C:\Users\Usman\.ssh\AWS_Access.pem admin@AWS-VPS
</code></pre><pre tabindex="0"><code>root@AWS-VPS:/home/admin# neofetch
       _,met$$$$$gg.          root@AWS-VPS
    ,g$$$$$$$$$$$$$$$P.       --------------------
  ,g$$P&quot;     &quot;&quot;&quot;Y$$.&quot;.        OS: Debian GNU/Linux 10 (buster) x86_64
 ,$$P'              `$$$.     Host: HVM domU 4.2.amazon
',$$P       ,ggs.     `$$b:   Kernel: 4.19.0-18-cloud-amd64
`d$$'     ,$P&quot;'   .    $$$    Uptime: 16 hours
 $$P      d$'     ,    $$P    Packages: 452 (dpkg)
 $$:      $$.   -    ,d$$'    Shell: bash 5.0.3
 $$;      Y$b._   _,d$P'      CPU: Intel Xeon E5-2686 v4 (1) @ 2.300GHz
 Y$$.    `.`&quot;Y$$$$P&quot;'         GPU: Cirrus Logic GD 5446
 `$$b      &quot;-.__              Memory: 74MiB / 987MiB
  `Y$$
   `Y$$.
     `$$b.
       `Y$$b.
          `&quot;Y$b._
              `&quot;&quot;&quot;
</code></pre><h2 id="installing-the-required-packages">Installing the required packages<a hidden class="anchor" aria-hidden="true" href="#installing-the-required-packages">#</a></h2>
<p>Next, I upgraded the system packages, installed WireGuard and the BIRD routing daemon.</p>
<pre tabindex="0"><code>root@AWS-VPS:~$ sudo apt update &amp;&amp; sudo apt upgrade -y
root@AWS-VPS:~$ sudo apt install wireguard
root@AWS-VPS:~$ sudo apt install bird
</code></pre><hr>
<h2 id="establishing-the-wireguard-vpn-tunnel">Establishing the WireGuard VPN Tunnel<a hidden class="anchor" aria-hidden="true" href="#establishing-the-wireguard-vpn-tunnel">#</a></h2>
<h3 id="generating-key-pairs">Generating Key Pairs<a hidden class="anchor" aria-hidden="true" href="#generating-key-pairs">#</a></h3>
<p>After the installation, I generated WireGuard Public and Private Key Pairs, on my EdgeRouter and VPS. Where each peer has public/private key pair, and only needs to know the peer&rsquo;s public key.</p>
<p>On the EdgeRouter:</p>
<pre tabindex="0"><code>usman@ER-X:~$ mkdir /home/usman/wgconfs/AWS
usman@ER-X:~$ cd /home/usman/wgconfs/AWS
usman@ER-X:~/wgconfs/AWS$ wg genkey | tee privatekey | wg pubkey &gt; publickey
usman@ER-X:~/wgconfs/AWS$ ls
private  public
</code></pre><p>On the VPS:</p>
<pre tabindex="0"><code>root@AWS-VPS:~$ cd /etc/wireguard/
root@AWS-VPS:/etc/wireguard$ wg genkey | tee privatekey | wg pubkey &gt; publickey
usman@AWS-VPS:~/etc/wireguard$ ls
private  public
</code></pre><hr>
<h2 id="wireguard-on-the-edgerouter">WireGuard on the EdgeRouter<a hidden class="anchor" aria-hidden="true" href="#wireguard-on-the-edgerouter">#</a></h2>
<pre tabindex="0"><code>set interfaces wireguard wg67 address 10.132.0.2/30
set interfaces wireguard wg67 mtu 1420
set interfaces wireguard wg67 peer LHv3equY4NyDeLVCY1+P5IrCA23+bYLixB18ehHjzzM= allowed-ips 0.0.0.0/0
set interfaces wireguard wg67 peer LHv3equY4NyDeLVCY1+P5IrCA23+bYLixB18ehHjzzM= endpoint 'aws.vps.com:51823'
set interfaces wireguard wg67 private-key /home/usman/wgconfs/privatekey
set interfaces wireguard wg67 route-allowed-ips false
</code></pre><p>What this does:</p>
<ul>
<li>Creates a WireGuard Interface, called <code>wg67 </code>with an IP address of <code>10.132.0.2</code></li>
<li>Sets the MTU to 1420</li>
<li>Creates a peer with the public key of <code>LHv3equY4NyDeLVCY1+P5IrCA23+bYLixB18ehHjzzM=</code></li>
<li>Allows any ip address to flow over the tunnel.</li>
<li>Specifies the public IP endpoint of the AWS VPS.</li>
<li>Associates the previously generated private key with the wg67 interface.</li>
<li>Set the <code>route-allowed-ips</code> value to false, as that would create a default route via the VPS.</li>
</ul>
<h3 id="allowing-wireguard-through-the-edgerouters-firewall">Allowing WireGuard through the EdgeRouter&rsquo;s firewall<a hidden class="anchor" aria-hidden="true" href="#allowing-wireguard-through-the-edgerouters-firewall">#</a></h3>
<pre tabindex="0"><code>set firewall name WAN_LOCAL rule 25 action accept
set firewall name WAN_LOCAL rule 25 description iBGP-AWS
set firewall name WAN_LOCAL rule 25 destination port 51823
set firewall name WAN_LOCAL rule 25 log enable
set firewall name WAN_LOCAL rule 25 protocol udp
</code></pre><p>What this does:</p>
<ul>
<li>Creates an accept rule in the WAN_LOCAL rule set, which regulates traffic from the WAN interface, to the router.</li>
<li>Accepts all incoming UDP connections on port 51823, from the AWS VPS.</li>
</ul>
<hr>
<h2 id="wireguard-on-the-aws-debian-vps">WireGuard on the AWS Debian VPS<a hidden class="anchor" aria-hidden="true" href="#wireguard-on-the-aws-debian-vps">#</a></h2>
<p>WireGuard on Linux is similar to the EdgeRouter&rsquo;s config.</p>
<pre tabindex="0"><code>ip link add dev wg0 type wireguard
ip address add dev wg0 10.132.0.1/30
wg set wg0 listen-port 51823 private-key /etc/wireguard/privatekey peer &lt;erxpubkey&gt; allowed-ips 0.0.0.0/0 endpoint &lt;erx.pub.ip&gt;:51823
ip link set up dev wg0

ip addr add 172.22.132.169/32 dev lo
</code></pre><p>What this does:</p>
<ul>
<li>Creates an interface called <code>wg0</code>, with the type wireguard.</li>
<li>Assigns the address <code>10.132.0.1/30</code> to the <code>wg0</code> interface.</li>
<li>Sets the server listen port to 51823.</li>
<li>Sets the privatekey to the location of the previously generated private key.</li>
<li>Allows any ip address over the tunnel.</li>
<li>Specifies the public IP and port of the EdgeRouter peer.</li>
</ul>
<h3 id="allowing-wireguard-through-awss-security-group">Allowing WireGuard through AWSs Security Group<a hidden class="anchor" aria-hidden="true" href="#allowing-wireguard-through-awss-security-group">#</a></h3>
<p>I also modified the VPS&rsquo;s security group, so that it allows incoming udp connections on port 51823, from the EdgeRouter.</p>
<p><img loading="lazy" src="/images/iBGP-AWS/Security-Group.PNG" alt="AWS Security Group"  title="AWS Security Group"  />
</p>
<hr>
<h3 id="testing-reachability">Testing Reachability<a hidden class="anchor" aria-hidden="true" href="#testing-reachability">#</a></h3>
<p>After configuring the Firewall Rules, I was able to ping between the VPS and EdgeRouter, over the WireGuard VPN Interface.</p>
<p>From the EdgeRouter, to the VPS:</p>
<pre tabindex="0"><code>usman@ER-X:~$ ping 10.132.0.1
PING 10.132.0.1 (10.132.0.1) 56(84) bytes of data.
64 bytes from 10.132.0.1: icmp_seq=1 ttl=64 time=31.4 ms
64 bytes from 10.132.0.1: icmp_seq=2 ttl=64 time=31.5 ms
64 bytes from 10.132.0.1: icmp_seq=3 ttl=64 time=35.0 ms
64 bytes from 10.132.0.1: icmp_seq=4 ttl=64 time=34.3 ms
64 bytes from 10.132.0.1: icmp_seq=5 ttl=64 time=31.8 ms
</code></pre><p>From the VPS to the EdgeRouter:</p>
<pre tabindex="0"><code>admin@AWS-VPS:~$ ping 10.132.0.2
PING 10.132.0.2 (10.132.0.2) 56(84) bytes of data.
64 bytes from 10.132.0.2: icmp_seq=1 ttl=64 time=39.4 ms
64 bytes from 10.132.0.2: icmp_seq=2 ttl=64 time=34.7 ms
64 bytes from 10.132.0.2: icmp_seq=3 ttl=64 time=34.8 ms
64 bytes from 10.132.0.2: icmp_seq=4 ttl=64 time=29.5 ms
64 bytes from 10.132.0.2: icmp_seq=5 ttl=64 time=28.9 ms
</code></pre><p>The latency ranges from 30-40 ms, which perfectly acceptable for a VPN connection over the internet.</p>
<p>WireGuard also provides some diagnostic data (e.g. data usage, latest handshake etc.).</p>
<p>On the EdgeRouter:</p>
<pre tabindex="0"><code>usman@ER-X:~$ sudo wg
interface: wg67
  public key: P1FrJ1IpHCFX3Tk/4aFxbrCbD4VDefwHaieVWDWoXx0=
  private key: (hidden)
  listening port: 51650

peer: LHv3equY4NyDeLVCY1+P5IrCA23+bYLixB18ehHjzzM=
  endpoint: AWS-pub.ip:51823
  allowed ips: 0.0.0.0/0
  latest handshake: 46 seconds ago
  transfer: 252.68 MiB received, 30.28 MiB sent
</code></pre><p>On the VPS:</p>
<pre tabindex="0"><code>root@AWS-VPS:~# wg
interface: wg67
  public key: LHv3equY4NyDeLVCY1+P5IrCA23+bYLixB18ehHjzzM=
  private key: (hidden)
  listening port: 51823

peer: P1FrJ1IpHCFX3Tk/4aFxbrCbD4VDefwHaieVWDWoXx0=
  endpoint: edgerouter-pub.ip:51650
  allowed ips: 0.0.0.0/0
  latest handshake: 46 seconds ago
  transfer: 30.21 MiB received, 252.70 MiB sent
</code></pre><hr>
<h2 id="ibgp-configuration">iBGP Configuration<a hidden class="anchor" aria-hidden="true" href="#ibgp-configuration">#</a></h2>
<p>Once the VPN was up, I set about creating a internal BGP peering between the EdgeRouter and VPS (so that the VPS could reach DN42, via the EdgeRouter&rsquo;s upstream transit peers).</p>
<p><img loading="lazy" src="/images/iBGP-AWS/bird.png" alt="BIRD"  title="BIRD"  />
</p>
<h3 id="why-bird-internet-routing-daemon">Why BIRD Internet Routing Daemon?<a hidden class="anchor" aria-hidden="true" href="#why-bird-internet-routing-daemon">#</a></h3>
<p>I chose to use the <em>free and open-source</em> <a href="https://bird.network.cz/">BIRD routing daemon</a> as its widely used in the DN42 mesh and on the real internet.</p>
<p>Netflix proudly uses BIRD to run their <a href="https://openconnect.netflix.com/en_gb/appliances/#software">global CDN backbone</a>, which handles ~<a href="https://freebsdfoundation.org/wp-content/uploads/2020/10/netflixcasestudy_final.pdf">100Tbps</a> at peak. So its probably fine for DN42&rsquo;s few hundred routes.</p>
<h3 id="bird-bgp-configuration-on-the-vps">BIRD BGP Configuration on the VPS<a hidden class="anchor" aria-hidden="true" href="#bird-bgp-configuration-on-the-vps">#</a></h3>
<p>Upon installation, BIRD created a template configuration file in <code>/etc/bird/bird.conf</code>.
I just had to add some parameters regarding my own BGP peering and WireGuard tunnel.</p>
<pre tabindex="0"><code>root@AWS-VPS:/etc/bird# vim bird.conf

router id 172.22.132.169;

protocol kernel {
  scan time 20;
  import none;
  export filter {
    if source = RTS_STATIC then reject;
    krt_prefsrc = 172.22.132.169;
    accept;
  };
};


protocol device {
        scan time 60;
}

protocol direct {
        interface &quot;*&quot;;
}

protocol bgp {
  description &quot;BIRD BGP CONFIG&quot;;
  local as 4242421869;
  neighbor 10.132.0.2 as 4242421869;
  graceful restart;
  import all;
  export all;
}
</code></pre><p>What this does:</p>
<ul>
<li>Sets the router ID <code>to 172.22.132.169</code> - an IP address in my designated DN42 range (claimed by my ASN).</li>
<li>Creates a kernel table. The Kernel protocol is not a real routing protocol. Instead of communicating with other routers in the network, it performs synchronization of BIRD&rsquo;s routing tables with the OS kernel.</li>
<li>Creates <code>protocol direct</code> and <code>protocol device</code>, which are BIRD specific settings.</li>
<li>Initialises the BGP protocol on BIRD, with the local ASN of <code>4242421869</code>.</li>
<li>Sets the neighbour remote ASN to <code>4242421869</code> via <code>10.132.0.2</code> (the WireGuard IP address for the EdgeRouter).</li>
<li>The use of the same local and remote ASN triggers internal BGP, as opposed to external BGP.</li>
</ul>
<h3 id="bgp-configuration-for-the-edgerouter">BGP Configuration for the EdgeRouter<a hidden class="anchor" aria-hidden="true" href="#bgp-configuration-for-the-edgerouter">#</a></h3>
<p>BGP on the EdgeRouter similar to BIRD.</p>
<pre tabindex="0"><code>set protocols bgp 4242421869 parameters router-id 172.22.132.161
set protocols bgp 4242421869 neighbor 10.132.0.1 description iBGP
set protocols bgp 4242421869 neighbor 10.132.0.1 nexthop-self
set protocols bgp 4242421869 neighbor 10.132.0.1 remote-as 4242421869
set protocols bgp 4242421869 neighbor 10.132.0.1 soft-reconfiguration inbound
</code></pre><p>What this does:</p>
<ul>
<li>Creates an instance of BGP, with my local ASN (4242421869) and router id 172.22.132.161.</li>
<li>Sets the neighbour remote ASN to <code>4242421869</code> via <code>10.132.0.1</code> (the WireGuard IP address for the AWS VPS).</li>
<li>Enables <code>next-hop self</code>, which forces the router to do a recursive lookup in order to determine which egress interface should be used to send the packets out.</li>
<li>Enables <code>soft-reconfiguration inbound</code>.</li>
</ul>
<hr>
<h2 id="verifying-the-ibgp-peering">Verifying the iBGP Peering<a hidden class="anchor" aria-hidden="true" href="#verifying-the-ibgp-peering">#</a></h2>
<p>On the EdgeRouter, the BGP state had changed to &ldquo;Established&rdquo;, its announcing 463 routes to the VPS, at IP <code>10.132.0.1</code> (the WireGuard peer IP).</p>
<pre tabindex="0"><code>usman@ER-X:~$ show ip bgp neighbors 10.132.0.1
BGP neighbor is 10.132.0.1, remote AS 4242421869, local AS 4242421869, internal link
  BGP version 4, remote router ID 172.22.132.169
  BGP state = Established, up for 17:26:23
  Last read 17:26:23, hold time is 180, keepalive interval is 60 seconds
  Neighbor capabilities:
    Route refresh: advertised and received (new)
    4-Octet ASN Capability: advertised and received
    Address family IPv4 Unicast: advertised and received
  Received 5794 messages, 21 notifications, 0 in queue
  Sent 20084 messages, 12 notifications, 0 in queue
  Route refresh request: received 0, sent 0
  Minimum time between advertisement runs is 5 seconds
 For address family: IPv4 Unicast
  BGP table version 43303, neighbor version 43303
  Index 0, Offset 0, Mask 0x1
    Graceful restart: received
  Inbound soft reconfiguration allowed
  NEXT_HOP is always this router
  Community attribute sent to this neighbor (both)
  0 accepted prefixes
  463 announced prefixes

 Connections established 23; dropped 22
Local host: 10.132.0.2, Local port: 179
Foreign host: 10.132.0.1, Foreign port: 54586
Nexthop: 10.132.0.2
Nexthop global: ::
Nexthop local: ::
BGP connection: non shared network
Last Reset: 17:26:23, due to BGP Notification sent
Notification Error Message: (Cease/Administratively Reset.)
</code></pre><p>On the AWS VPS:</p>
<p>After entering the <code>birdc</code> shell on the VPS, I could also see that the BGP state had been <code>established</code>.</p>
<p>Its accepting those 463 routes that the EdgeRouter advertised, over the WireGuard tunnel (IP address <code>10.132.0.2</code>).</p>
<pre tabindex="0"><code>root@AWS-VPS:~# birdc 
bird&gt; show protocols bgp1
bgp1     BGP      master   up     16:37:06    Established
  Description:    BIRD BGP CONFIG
  Preference:     100
  Input filter:   ACCEPT
  Output filter:  REJECT
  Routes:         463 imported, 0 exported, 463 preferred
  Route change stats:     received   rejected   filtered    ignored   accepted
    Import updates:            466          0          0          0        466
    Import withdraws:            0          0        ---          0          0
    Export updates:            469        466          3        ---          0
    Export withdraws:            0        ---        ---        ---          0
  BGP state:          Established
    Neighbor address: 10.132.0.2
    Neighbor AS:      4242421869
    Neighbor ID:      172.22.132.161
    Neighbor caps:    refresh AS4
    Session:          internal multihop AS4
    Source address:   10.132.0.1
    Hold timer:       147/180
    Keepalive timer:  40/60
bird&gt;
</code></pre><hr>
<h3 id="inspecting-vpss-route-table">Inspecting VPS&rsquo;s Route Table<a hidden class="anchor" aria-hidden="true" href="#inspecting-vpss-route-table">#</a></h3>
<p>The AWS VPS now has DN42&rsquo;s prefixes in its kernel route table.</p>
<p>DN42 prefixes (172.20.0.0/14) have a gateway of the EdgeRouter, (over the WireGuard VPN tunnel).</p>
<p><code>route -n</code> showing a subset of the VPS&rsquo;s route table:</p>
<pre tabindex="0"><code>root@AWS-VPS:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         172.31.0.1      0.0.0.0         UG    0      0        0 eth0
172.20.0.53     10.132.0.2      255.255.255.255 UGH   0      0        0 wg0
172.20.1.0      10.132.0.2      255.255.255.0   UG    0      0        0 wg0
172.20.4.32     10.132.0.2      255.255.255.240 UG    0      0        0 wg0
172.20.4.96     10.132.0.2      255.255.255.248 UG    0      0        0 wg0
172.20.4.104    10.132.0.2      255.255.255.248 UG    0      0        0 wg0
172.20.6.224    10.132.0.2      255.255.255.248 UG    0      0        0 wg0
172.20.6.248    10.132.0.2      255.255.255.248 UG    0      0        0 wg0
172.20.8.0      10.132.0.2      255.255.254.0   UG    0      0        0 wg0
172.20.12.192   10.132.0.2      255.255.255.224 UG    0      0        0 wg0
172.20.14.32    10.132.0.2      255.255.255.224 UG    0      0        0 wg0
172.20.14.64    10.132.0.2      255.255.255.224 UG    0      0        0 wg0
172.20.14.192   10.132.0.2      255.255.255.192 UG    0      0        0 wg0
172.20.15.96    10.132.0.2      255.255.255.224 UG    0      0        0 wg0
172.20.16.0     10.132.0.2      255.255.255.128 UG    0      0        0 wg0
172.20.16.128   10.132.0.2      255.255.255.128 UG    0      0        0 wg0
172.20.18.64    10.132.0.2      255.255.255.224 UG    0      0        0 wg0
172.20.18.224   10.132.0.2      255.255.255.240 UG    0      0        0 wg0
172.20.19.64    10.132.0.2      255.255.255.224 UG    0      0        0 wg0
172.20.20.96    10.132.0.2      255.255.255.224 UG    0      0        0 wg0
172.20.28.224   10.132.0.2      255.255.255.224 UG    0      0        0 wg0
</code></pre><h3 id="ping-testing">Ping Testing<a hidden class="anchor" aria-hidden="true" href="#ping-testing">#</a></h3>
<p>Success! Pinging a device inside the DN42 range <code>172.23.0.80</code> confirms that I have access to the DN42 network.</p>
<pre tabindex="0"><code>root@ip-172-31-0-189:~# ping 172.23.0.80
PING 172.23.0.80 (172.23.0.80) 56(84) bytes of data.
64 bytes from 172.23.0.80: icmp_seq=1 ttl=60 time=69.3 ms
64 bytes from 172.23.0.80: icmp_seq=2 ttl=60 time=72.7 ms
64 bytes from 172.23.0.80: icmp_seq=3 ttl=60 time=71.7 ms
64 bytes from 172.23.0.80: icmp_seq=4 ttl=60 time=83.8 ms
64 bytes from 172.23.0.80: icmp_seq=5 ttl=60 time=74.5 ms
</code></pre><h3 id="traceroute-testing">Traceroute Testing<a hidden class="anchor" aria-hidden="true" href="#traceroute-testing">#</a></h3>
<p>A traceroute to <code>172.23.0.80</code> confirms that the packets are flowing:</p>
<ul>
<li>First through the Ubiquiti EdgeRouter <code>10.132.0.2</code> over the WG VPN tunnel</li>
<li>Next through the EdgeRouter&rsquo;s eBGP peering with &lsquo;highdef&rsquo; <code>172.20.229.116</code></li>
<li>Through the DN42 network</li>
<li>And finally reaches its destination in 5 total hops.</li>
</ul>
<pre tabindex="0"><code>root@AWS-VPS:~# traceroute 172.23.0.80
traceroute to 172.23.0.80 (172.23.0.80), 30 hops max, 60 byte packets
 1  10.132.0.2  33.135 ms  33.105 ms  33.088 ms
 2  172.20.229.116  52.967 ms  52.948 ms  52.932 ms
 3  172.20.129.187  60.474 ms  60.459 ms  60.438 ms
 4  172.20.129.169  73.126 ms  73.102 ms  78.113 ms
 5  172.23.0.80  78.097 ms  78.078 ms  78.061 ms
</code></pre><h2 id="what-next">What Next?<a hidden class="anchor" aria-hidden="true" href="#what-next">#</a></h2>
<p>In the future, I&rsquo;ll probably launch another VPS, create more BGP peering, but install everything automatically with Ansible.</p>


  </div>

  <footer class="post-footer">
<nav class="paginav">
  <a class="prev" href="https://blog.usman.network/posts/hurricane-electric-ipv6/">
    <span class="title">« Prev Page</span>
    <br>
    <span>Hurricane Electric IPv6 Tunnel Broker On a Ubiquiti EdgeRouter</span>
  </a>
  <a class="next" href="https://blog.usman.network/posts/dn42-bgp/">
    <span class="title">Next Page »</span>
    <br>
    <span>DN42 Part 1: Connecting to the DN42 BGP Mesh</span>
  </a>
</nav>

  </footer><div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {

    this.page.url = 'https:\/\/blog.usman.network\/posts\/ibgp-aws\/';
    this.page.identifier = 'https:\/\/blog.usman.network\/posts\/ibgp-aws\/';
    this.page.title = 'DN42 Part 2: Conecting an AWS VPS to DN42, using iBGP and WireGuard.';
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "blog-usman-network" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://blog.usman.network/">UsmanNet</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
const images = Array.from(document.querySelectorAll(".post-content img"));
images.forEach(img => {
  mediumZoom(img, {
    margin: 0,  
    scrollOffset: 40,  
    container: null,  
    template: null  
  });
});
</script>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
